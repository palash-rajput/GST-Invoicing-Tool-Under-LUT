<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Generator (India ‚Üí US ¬∑ Under LUT)</title>

    <!-- Google Fonts - Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        * {
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, sans-serif;
}

body {
  margin: 0;
  background: #f6f7f9;
  color: #111;
}

.container {
  display: grid;
  grid-template-columns: 360px 1fr;
  height: 100vh;
}

/* LEFT FORM */
.form-container {
  background: #ffffff;
  padding: 32px;
  padding-bottom: 100px; /* Space for fixed nav with 2 buttons */
  overflow-y: auto;
  border-right: 1px solid #e5e7eb;
  position: relative;
  font-family: Montserrat, sans-serif; /* Match invoice font */
}

.step-indicator {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding-bottom: 20px;
  margin-bottom: 24px;
  border-bottom: 2px solid #e5e7eb;
  font-family: Montserrat, sans-serif;
}

.step {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  flex: 1;
  cursor: pointer;
  transition: all 0.2s;
}

.step.active .step-number {
  background: #2770f1;
  color: white;
  border-color: #2770f1;
}

.step.active .step-label {
  color: #2770f1;
  font-weight: 600;
}

.step.completed .step-number {
  background: #10b981;
  color: white;
  border-color: #10b981;
}

.step-number {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: 2px solid #d1d5db;
  background: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 700;
  color: #6b7280;
  transition: all 0.2s;
}

.step-label {
  font-size: 10px;
  font-weight: 500;
  color: #6b7280;
  text-align: center;
  transition: all 0.2s;
}

.step-divider {
  flex: 0 0 8px;
  height: 2px;
  background: #e5e7eb;
  margin: 0 -2px;
  margin-bottom: 16px;
}

.form-step {
  display: none;
}

.form-step.active {
  display: block;
}

.form-step h2 {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 16px;
  color: #333;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  font-family: Montserrat, sans-serif;
}

label {
  font-family: Montserrat, sans-serif;
  font-size: 12px;
  font-weight: 600;
  color: #333;
  display: block;
  margin-bottom: 5px;
  margin-top: 10px;
}

input,
textarea,
select {
  font-family: Montserrat, sans-serif;
  width: 100%;
  padding: 8px 10px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 12px;
  color: #333;
  line-height: 1.5;
}

input:focus,
textarea:focus,
select:focus {
  outline: none;
  border-color: #2770f1;
  box-shadow: 0 0 0 3px rgba(39, 112, 241, 0.1);
}

textarea {
  resize: vertical;
  min-height: 70px;
}

.toggle-label {
  margin-top: 12px;
  font-size: 14px;
}

.link-small {
  color: #2770f1;
  font-size: 12px;
  font-family: Montserrat, sans-serif;
  text-decoration: none;
  display: inline-block;
  margin-top: 4px;
}

.link-small:hover {
  text-decoration: underline;
}

.fixed-box {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 16px;
  margin-top: 20px;
  font-family: Montserrat, sans-serif;
}

.fixed-box p {
  margin: 8px 0;
  font-size: 12px;
  color: #333;
  line-height: 1.6;
}

button#addItemBtn {
  background: #2770f1;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 10px 16px;
  font-family: Montserrat, sans-serif;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 12px;
  transition: background-color 0.2s;
  width: 100%;
}

button#addItemBtn:hover {
  background: #1d5dd8;
}

/* Multi-column field layouts */
.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-top: 10px;
}

.form-field {
  display: flex;
  flex-direction: column;
}

.form-field label {
  margin-top: 0;
}

.form-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 360px;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 16px 24px;
  background: #ffffff;
  border-top: 1px solid #e5e7eb;
  border-right: 1px solid #e5e7eb;
  z-index: 10;
}

.form-nav button {
  padding: 12px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  font-weight: 600;
}

#prevBtn, #nextBtn {
  flex: 1;
}

#prevBtn {
  background: #e5e7eb;
}

#nextBtn {
  background: #111827;
  color: #fff;
}

.hidden {
  display: none;
}

/* TOGGLE SWITCH */
.toggle-switch {
  position: relative;
  width: 50px;
  height: 24px;
  display: inline-block;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  border-radius: 24px;
  transition: 0.3s;
}

.toggle-slider:before {
  content: "";
  position: absolute;
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  border-radius: 50%;
  transition: 0.3s;
}

input:checked + .toggle-slider {
  background-color: #2770f1;
}

input:checked + .toggle-slider:before {
  transform: translateX(26px);
}

/* RIGHT PREVIEW */
.preview-container {
  background: #f3f4f6;
  overflow-y: auto;
  padding: 40px;
  position: relative;
}

#downloadPdfBtn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  padding: 14px 24px;
  background: #2770f1;
  color: #fff;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.2s;
  z-index: 100;
  box-shadow: 0 4px 12px rgba(39, 112, 241, 0.3);
}

#downloadPdfBtn:hover {
  background: #1d5dd8;
  box-shadow: 0 6px 16px rgba(39, 112, 241, 0.4);
}

#invoicePreview {
  background: #ffffff;
  max-width: 900px;
  margin: auto;
  padding: 36px;
  border-radius: 8px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.06);
}

.header-section {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.header-right {
  text-align: right;
}

.header-right p {
  margin: 6px 0;
  font-size: 14px;
}

.header-right strong {
  color: #374151;
}

.invoice-label {
  color: #2563eb;
  font-weight: 700;
  font-size: 16px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

.header-left h1 {
  margin: 6px 0 12px 0;
  font-size: 32px;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.header-left p {
  margin: 6px 0;
  font-size: 14px;
  line-height: 1.5;
  color: #374151;
}

.header-left strong {
  color: #111827;
}

.company-logo {
  max-height: 80px;
  max-width: 80px;
  margin-bottom: 12px;
  display: block;
}

hr {
  margin: 28px 0;
  border: none;
  border-top: 1px solid #e5e7eb;
}

/* BILL + ITEMS */
.bill-items-wrapper {
  display: grid;
  grid-template-columns: 1fr 2fr;
  gap: 24px;
}

.bill-to h2 {
  margin: 6px 0;
  font-size: 20px;
  font-weight: 700;
}

.bill-to h3 {
  font-size: 14px;
  font-weight: 600;
  color: #6b7280;
  margin-bottom: 12px;
}

.items-header {
  display: flex;
  justify-content: space-between;
  font-weight: 700;
  padding-bottom: 12px;
  border-bottom: 2px solid #e5e7eb;
}

.items-header h3 {
  font-size: 14px;
  color: #374151;
}

.item-row {
  margin-top: 16px;
}

.item-title {
  font-weight: 600;
}

.amount {
  float: right;
  font-weight: 600;
}

.total-line {
  margin-top: 24px;
  padding-top: 16px;
  border-top: 2px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  font-size: 18px;
  font-weight: 700;
  color: #2563eb;
}

.inr-section {
  margin-top: 16px;
  padding: 12px 0;
  border-top: 1px solid #e5e7eb;
}

.inr-section h4 {
  margin: 0 0 6px 0;
  font-size: 14px;
  font-weight: 600;
  color: #374151;
}

.inr-section span {
  font-size: 16px;
  font-weight: 700;
  color: #111827;
}

.signature-block {
  margin-top: 32px;
  text-align: right;
}

.signature-img {
  max-height: 70px;
}

/* PAYMENT */
.payment-section h3 {
  margin-bottom: 10px;
}

#payNowBtn {
  display: inline-block;
  background: #2563eb;
  color: #fff;
  padding: 16px 32px;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 700;
  font-size: 16px;
  transition: background 0.2s;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

#payNowBtn:hover {
  background: #1d4ed8;
}

.small-text {
  font-size: 12px;
  margin-top: 6px;
}

.payment-lower {
  display: flex;
  gap: 24px;
  margin-top: 20px;
}

.qr-img {
  max-width: 120px;
}

.bank-details p {
  margin: 4px 0;
}

.export-declaration {
  margin-top: 24px;
}

.export-declaration h3 {
  font-size: 14px;
  font-weight: 700;
  color: #374151;
  margin-bottom: 8px;
}

.export-declaration p {
  font-size: 14px;
  color: #6b7280;
  line-height: 1.6;
}

/* ===== WEBFLOW INVOICE DESIGN CSS ===== */
#invoicePreview {
  font-family: Montserrat, sans-serif;
  max-width: 960px;
  padding: 32px;
}

#invoicePreview .header {
  flex-flow: row;
  justify-content: space-between;
  display: flex;
  margin-bottom: 24px;
}

#invoicePreview .company-details {
  max-width: 540px;
}

#invoicePreview .div-block-6 {
  display: flex;
  justify-content: flex-end;
  align-items: flex-start;
  flex: 1;
}

#invoicePreview .invoice-details {
  flex-flow: column;
  justify-content: flex-start;
  align-items: flex-end;
  display: flex;
}

#invoicePreview .invoice {
  color: #2770f1;
  text-transform: uppercase;
  margin-bottom: 32px;
  font-size: 16px;
  font-weight: 700;
}

#invoicePreview .company-name {
  text-transform: uppercase;
  margin-bottom: 15px;
  font-size: 32px;
  font-weight: 800;
  line-height: 32px;
}

#invoicePreview .gst-pan {
  grid-column-gap: 20px;
  grid-row-gap: 20px;
  margin-bottom: 8px;
  display: flex;
}

#invoicePreview .text-block {
  color: #333;
  font-size: 13px;
  line-height: 20px;
}

#invoicePreview .text-block.semi {
  font-weight: 600;
}

#invoicePreview .text-block.large {
  font-size: 16px;
  font-weight: 700;
}

#invoicePreview .text-block.large.blue {
  color: #2770f1;
}

#invoicePreview .text-block.small {
  font-size: 10px;
}

#invoicePreview .text-block.small._10-blue {
  color: #2770f1;
  margin-bottom: -2px;
  margin-left: 4px;
}

#invoicePreview .gst, #invoicePreview .pan {
  grid-column-gap: 6px;
  grid-row-gap: 6px;
  display: flex;
}

#invoicePreview .address {
  margin-bottom: 8px;
}

#invoicePreview .email-phone {
  grid-column-gap: 20px;
  grid-row-gap: 20px;
  margin-bottom: 0;
  display: flex;
}

#invoicePreview .email, #invoicePreview .phone {
  grid-column-gap: 6px;
  grid-row-gap: 6px;
  display: flex;
}

#invoicePreview .logo-container {
  width: 70px;
  height: 70px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}

#invoicePreview .company-logo {
  max-width: 70px;
  max-height: 70px;
  object-fit: contain;
}

#invoicePreview .invoice-number, #invoicePreview .invoice-date, #invoicePreview .export-type {
  grid-column-gap: 6px;
  grid-row-gap: 6px;
  margin-bottom: 8px;
  display: flex;
}

#invoicePreview .lut-number {
  grid-column-gap: 6px;
  grid-row-gap: 6px;
  margin-bottom: 0;
  display: flex;
}

#invoicePreview .divider-line-1 {
  background-color: #3336;
  height: 1px;
  margin-top: 30px;
  margin-bottom: 0;
}

#invoicePreview ._2-part-section {
  display: flex;
}

#invoicePreview .part-1 {
  border-right: 1px solid #3336;
  min-width: 288px;
}

#invoicePreview .part-2 {
  width: 100%;
}

#invoicePreview .bill-to {
  grid-column-gap: 6px;
  grid-row-gap: 6px;
  flex-flow: column;
  margin-bottom: 20px;
  display: flex;
}

#invoicePreview .client-company-name {
  font-size: 24px;
  font-weight: 700;
  line-height: 24px;
}

#invoicePreview .contact-person {
  grid-column-gap: 2px;
  grid-row-gap: 2px;
  flex-flow: column;
  margin-bottom: 10px;
  display: flex;
}

#invoicePreview .client-address, #invoicePreview .client-country, #invoicePreview .client-email, #invoicePreview .client-gstin {
  grid-column-gap: 0px;
  grid-row-gap: 0px;
  flex-flow: column;
  margin-bottom: 10px;
  display: flex;
}

#invoicePreview .billing-details {
  border-bottom: 1px solid #3336;
  padding-top: 30px;
  padding-bottom: 30px;
}

#invoicePreview .payment-button {
  border-bottom: 1px #3336;
  flex-flow: column;
  justify-content: center;
  align-items: center;
  padding-top: 20px;
  padding-bottom: 30px;
  display: flex;
}

#invoicePreview .button {
  color: #fff;
  background-color: #2770f1;
  border-radius: 8px;
  justify-content: center;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
  padding: 16px 24px;
  font-size: 16px;
  font-weight: 600;
  line-height: 20px;
  display: inline-flex;
  text-decoration: lowercase;
  transition: background-color 0.2s;
  min-width: 220px;
}

#invoicePreview .button:hover {
  background-color: #1d5dd8;
}

#invoicePreview .services {
  border-bottom: 1px solid #3336;
  flex-flow: column;
  justify-content: space-between;
  padding-top: 30px;
  padding-bottom: 10px;
  padding-left: 32px;
  display: flex;
}

#invoicePreview .nav {
  justify-content: space-between;
  align-items: stretch;
  margin-bottom: 15px;
  display: flex;
}

#invoicePreview .items {
  justify-content: space-between;
  margin-bottom: 40px;
  display: flex;
}

#invoicePreview .service-details {
  grid-column-gap: 12px;
  grid-row-gap: 12px;
  flex-flow: column;
  width: 430px;
  display: flex;
}

#invoicePreview .item-calculation {
  margin-top: 60px;
}

#invoicePreview .total-usd {
  border-bottom: 1px solid #3333331a;
  justify-content: space-between;
  margin-bottom: 12px;
  padding-bottom: 12px;
  display: flex;
}

#invoicePreview .div-block {
  justify-content: flex-start;
  align-items: flex-end;
  display: flex;
}

#invoicePreview .total-inr {
  border-bottom: 1px #3333331a;
  justify-content: space-between;
  padding-bottom: 12px;
  display: flex;
}

#invoicePreview .total-inr-usd {
  margin-bottom: 10px;
}

#invoicePreview .invoice-currency, #invoicePreview .rbi-rate, #invoicePreview .gst-amount, #invoicePreview .gst-rate, #invoicePreview .place-of-supply {
  grid-column-gap: 6px;
  grid-row-gap: 6px;
  margin-bottom: 6px;
  display: flex;
}

#invoicePreview .rate-signature {
  justify-content: space-between;
  display: flex;
}

#invoicePreview .signature-container {
  height: 91px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 0;
}

#invoicePreview .signature {
  max-width: 160px;
  max-height: 91px;
  transform: rotate(-12deg);
  object-fit: contain;
}

#invoicePreview .signature-detail {
  grid-column-gap: 2px;
  grid-row-gap: 2px;
  flex-flow: column;
  justify-content: center;
  align-items: center;
  margin-bottom: 15px;
  display: flex;
}

#invoicePreview .div-block-2 {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  margin-top: -9px;
}

#invoicePreview .payment-terms {
  border-bottom: 1px solid #3336;
  padding-top: 30px;
  padding-bottom: 30px;
  padding-left: 32px;
  display: none;
}

#invoicePreview .terms {
  grid-column-gap: 12px;
  grid-row-gap: 6px;
  flex-flow: column;
  margin-bottom: 20px;
  display: flex;
}

#invoicePreview .bank-details {
  padding-bottom: 0;
}

#invoicePreview .bank-details-1 {
  padding-left: 20px;

}

#invoicePreview .payment-info {
  display: flex;
  gap: 0;
  align-items: flex-start;
}

#invoicePreview .wise-bank-code {
  width: 210px;
  display: none;
  padding-right: 30px;
  flex-shrink: 0;
}

#invoicePreview .wise-qr {
  width: 190px;
}

#invoicePreview .bank {
  grid-column-gap: 6px;
  grid-row-gap: 6px;
  margin-bottom: 12px;
  display: flex;
}

#invoicePreview .div-block-3 {
  display: flex;
}


#invoicePreview .div-block-5 {
  flex-flow: column;
  justify-content: center;
  align-items: flex-start;
  display: flex;
}

#invoicePreview .declaration {
  border-bottom: 1px #3336;
  padding-top: 30px;
  padding-bottom: 30px;
  padding-left: 32px;
}

#invoicePreview .cost {
  min-width: 130px;
  text-align: right;
}

/* Dashboard Styles - Black & White with Blue Accents, matching invoice design */
.dashboard-view {
  min-height: 100vh;
  background: #ffffff;
  padding: 40px;
}

.dashboard-container {
  max-width: 1400px;
  margin: 0 auto;
}

.dashboard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 2px solid #000000;
}

.dashboard-header h1 {
  color: #000000;
  font-size: 28px;
  font-weight: 700;
  margin: 0;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.btn-primary {
  background: #4169E1;
  color: white;
  border: 2px solid #4169E1;
  padding: 10px 20px;
  border-radius: 4px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.btn-primary:hover {
  background: #2952CC;
  border-color: #2952CC;
}

/* Spreadsheet-style table */
.invoices-list {
  border: 1px solid #000000;
  background: #ffffff;
}

.invoice-table-header {
  display: grid;
  grid-template-columns: 180px 120px 1fr 1fr 150px 340px;
  gap: 0;
  padding: 12px 20px;
  background: #f5f5f5;
  border-bottom: 2px solid #000000;
  font-weight: 700;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: #000000;
  align-items: start;
}

.invoice-row {
  display: grid;
  grid-template-columns: 180px 120px 1fr 1fr 150px 340px;
  gap: 0;
  padding: 12px 20px;
  border-bottom: 1px solid #cccccc;
  transition: background 0.15s ease;
  align-items: start;
}

.invoice-row:hover {
  background: #fafafa;
}

.invoice-row:last-child {
  border-bottom: none;
}

.invoice-cell {
  padding-right: 12px;
  color: #000000;
  font-size: 14px;
}

.invoice-cell-number {
  font-weight: 700;
}

.invoice-cell-date {
  color: #555555;
}

.invoice-cell-client {
  font-weight: 600;
}

.invoice-cell-person {
  color: #666666;
  font-size: 13px;
}

.invoice-cell-amount {
  font-weight: 700;
  text-align: left;
  color: #000000;
}

.invoice-cell-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-start;
}

.btn-action {
  padding: 6px 14px;
  border: 1px solid;
  border-radius: 3px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s ease;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  background: white;
}

.btn-edit {
  border-color: #4169E1;
  color: #4169E1;
}

.btn-edit:hover {
  background: #4169E1;
  color: white;
}

.btn-download {
  border-color: #666666;
  color: #666666;
}

.btn-download:hover {
  background: #666666;
  color: white;
}

.btn-view {
  background: #2563eb;
  color: white;
  padding: 6px 16px;
  border-radius: 4px;
  text-decoration: none;
  font-size: 14px;
  font-weight: 500;
  display: inline-block;
  transition: all 0.15s ease;
  border: none;
}

.btn-view:hover {
  background: #1d4ed8;
}

.btn-delete {
  border-color: #DC143C;
  color: #DC143C;
}

.btn-delete:hover {
  background: #DC143C;
  color: white;
}

.empty-state {
  text-align: center;
  padding: 80px 20px;
  color: #666666;
  border: 1px solid #cccccc;
}

.empty-state h2 {
  font-size: 24px;
  margin-bottom: 12px;
  color: #000000;
  font-weight: 700;
}

.empty-state p {
  font-size: 16px;
  color: #666666;
}

/* Back to Dashboard button */
.back-to-dashboard {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #4169E1;
  color: white;
  border: 2px solid #4169E1;
  padding: 10px 20px;
  border-radius: 4px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  z-index: 1000;
  transition: all 0.2s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.back-to-dashboard:hover {
  background: #2952CC;
  border-color: #2952CC;
}

    </style>
</head>

<body>

<div class="container">
    <!-- Back to Dashboard button (hidden when on dashboard) -->
    <button class="back-to-dashboard" id="backToDashboardBtn" style="display: none;">‚Üê Back to Dashboard</button>

    <!-- LEFT SIDE FORM -->
    <div class="form-container">

        <!-- STEP PROGRESS INDICATOR -->
        <div class="step-indicator">
            <div class="step" data-step="1">
                <div class="step-number">1</div>
                <div class="step-label">Info</div>
            </div>
            <div class="step-divider"></div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <div class="step-label">Invoice</div>
            </div>
            <div class="step-divider"></div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <div class="step-label">Client</div>
            </div>
            <div class="step-divider"></div>
            <div class="step" data-step="4">
                <div class="step-number">4</div>
                <div class="step-label">Services</div>
            </div>
            <div class="step-divider"></div>
            <div class="step" data-step="5">
                <div class="step-number">5</div>
                <div class="step-label">Payment</div>
            </div>
            <div class="step-divider"></div>
            <div class="step" data-step="6">
                <div class="step-number">6</div>
                <div class="step-label">Sign</div>
            </div>
        </div>

        <!-- STEP 1 ‚Äì YOUR INFORMATION -->
        <div class="form-step active" data-step="1">
            <h2>Your Information</h2>

            <label>Company Name</label>
            <input type="text" id="companyName">

            <label>GSTIN Number</label>
            <input type="text" id="gstin">

            <label>PAN Number</label>
            <input type="text" id="pan">

            <label>Address (Line 1)</label>
            <input type="text" id="companyAddressLine1">

            <div class="form-row">
                <div class="form-field">
                    <label>City</label>
                    <input type="text" id="companyCity">
                </div>
                <div class="form-field">
                    <label>State</label>
                    <input type="text" id="companyState">
                </div>
            </div>

            <div class="form-row">
                <div class="form-field">
                    <label>Country</label>
                    <input type="text" id="companyCountry">
                </div>
                <div class="form-field">
                    <label>Pin Code</label>
                    <input type="text" id="companyPinCode">
                </div>
            </div>

            <label>Email</label>
            <input type="email" id="companyEmail">

            <label>Phone</label>
            <input type="text" id="companyPhone">

            <label>Company Logo (optional)</label>
            <input type="file" id="companyLogo" accept="image/*">
        </div>

        <!-- STEP 2 ‚Äì INVOICE DETAILS -->
        <div class="form-step" data-step="2">
            <h2>Invoice Details</h2>

            <div class="form-row">
                <div class="form-field">
                    <label>Invoice Number</label>
                    <input type="text" id="invoiceNumber">
                </div>
                <div class="form-field">
                    <label>Invoice Date</label>
                    <input type="date" id="invoiceDate">
                </div>
            </div>


            <div class="form-row">
                <div class="form-field">
                    <label>LUT Number</label>
                    <input type="text" id="lutNumber">
                </div>
                <div class="form-field">
                      <label>Invoice Currency</label>
                        <select id="invoiceCurrency">
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="GBP">GBP</option>
                            <option value="AUD">AUD</option>
                            <option value="CAD">CAD</option>
                        </select>
                </div>
            </div>
            
            <label>RBI Exchange Rate</label>
            <input type="number" id="exchangeRate" step="0.0001">
            <a href="https://www.msei.in/markets/currency/historical-data/rbireferenceratearchives" 
               target="_blank" class="link-small">View Today's Rate</a>

            <label>Place of Supply</label>
            <select id="placeOfSupply">
                <option value="Andhra Pradesh">Andhra Pradesh</option>
                <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                <option value="Assam">Assam</option>
                <option value="Bihar">Bihar</option>
                <option value="Chhattisgarh">Chhattisgarh</option>
                <option value="Goa">Goa</option>
                <option value="Gujarat">Gujarat</option>
                <option value="Haryana">Haryana</option>
                <option value="Himachal Pradesh">Himachal Pradesh</option>
                <option value="Jharkhand">Jharkhand</option>
                <option value="Karnataka">Karnataka</option>
                <option value="Kerala">Kerala</option>
                <option value="Madhya Pradesh">Madhya Pradesh</option>
                <option value="Maharashtra">Maharashtra</option>
                <option value="Manipur">Manipur</option>
                <option value="Meghalaya">Meghalaya</option>
                <option value="Mizoram">Mizoram</option>
                <option value="Nagaland">Nagaland</option>
                <option value="Odisha">Odisha</option>
                <option value="Punjab">Punjab</option>
                <option value="Rajasthan">Rajasthan</option>
                <option value="Sikkim">Sikkim</option>
                <option value="Tamil Nadu">Tamil Nadu</option>
                <option value="Telangana">Telangana</option>
                <option value="Tripura">Tripura</option>
                <option value="Uttar Pradesh">Uttar Pradesh</option>
                <option value="Uttarakhand">Uttarakhand</option>
                <option value="West Bengal">West Bengal</option>
            </select>

            <div class="fixed-box">
                <p><strong>Export Type:</strong> Export of Service Under LUT</p>
                <p><strong>GST Rate:</strong> 0%</p>
                <p><strong>GST Amount:</strong> Nil</p>
                <p><strong>IGST Payable:</strong> No</p>
            </div>
        </div>

        <!-- STEP 3 ‚Äì CLIENT INFORMATION -->
        <div class="form-step" data-step="3">
            <h2>Client Information</h2>

            <label>Company Name</label>
            <input type="text" id="clientCompany">

            <label>Contact Person</label>
            <input type="text" id="clientPerson">

            <label>Address (Line 1)</label>
            <input type="text" id="clientAddressLine1">

            <div class="form-row">
                <div class="form-field">
                    <label>State</label>
                    <input type="text" id="clientState">
                </div>
                <div class="form-field">
                    <label>Pin Code</label>
                    <input type="text" id="clientPinCode">
                </div>
            </div>

            <label>Country</label>
            <select id="clientCountrySelect">
                <option value="United States of America">United States of America</option>
                <option value="Canada">Canada</option>
                <option value="Australia">Australia</option>
                <option value="United Kingdom">United Kingdom</option>
            </select>

            <label>Email</label>
            <input type="email" id="clientEmail">

            <label>Client GSTIN</label>
            <input type="text" id="clientGSTIN" value="Unregistered / Overseas">
        </div>

        <!-- STEP 4 ‚Äì SERVICE DETAILS -->
        <div class="form-step" data-step="4">
            <h2>Service Details</h2>

            <div id="itemsContainer"></div>

            <button type="button" id="addItemBtn">+ Add Item</button>
        </div>

        <!-- STEP 5 ‚Äì PAYMENT TERMS -->
        <div class="form-step" data-step="5">
            <h2>Payment Terms</h2>

            <div class="form-row">
                <div class="form-field">
                    <label>Support Email</label>
                    <input type="text" id="supportEmail">
                </div>
                <div class="form-field">
                    <label>Due Date (Days)</label>
                    <input type="number" id="dueDays">
                </div>
            </div>

            <label>Payment Link</label>
            <input type="url" id="paymentLink">

            <div style="display: flex; align-items: center; gap: 12px; margin-top: 12px; justify-content: space-between;">
                <span style="font-size: 12px;">Add Bank Details?</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="bankDetailsToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div id="bankContainer" class="hidden">
                <label>Bank</label>
                <input type="text" id="bankName">

                <label>Account Holder</label>
                <input type="text" id="bankHolder">

                <div class="form-row">
                    <div class="form-field">
                       <label>Account Number</label>
                                <input type="text" id="bankNumber">
                    </div>
                    <div class="form-field">
                        <label>IFSC Code</label>
                                <input type="text" id="bankIFSC">
                    </div>
                </div>
              
                <label>Bank Branch</label>
                <input type="text" id="bankBranch">

                <div style="display: flex; align-items: center; gap: 12px; margin-top: 20px; margin-bottom: 12px; justify-content: space-between;">
                    <span style="font-size: 12px;">Add QR Code?</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="qrCodeToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div id="qrCodeContainer" class="hidden">
                    <label>QR Code</label>
                    <input type="file" id="qrImage" accept="image/*">
                </div>
            </div>
        </div>

        <!-- STEP 6 ‚Äì SIGNATURE -->
        <div class="form-step" data-step="6">
            <h2>Signature</h2>

            <div class="form-row">
                <div class="form-field">
                    <label>Signature Name</label>
                    <input type="text" id="signatureName">
                </div>
                <div class="form-field">
                    <label>Signature Title</label>
                    <input type="text" id="signatureTitle">
                </div>
            </div>

            <label>Upload Signature</label>
            <input type="file" id="signatureImage" accept="image/*">
        </div>

        <!-- NAVIGATION -->
        <div class="form-nav">
            <button id="prevBtn" disabled>Previous</button>
            <button id="nextBtn">Next</button>
        </div>

    </div>

    <!-- RIGHT SIDE PREVIEW -->
    <div class="preview-container">

        <!-- FLOATING DOWNLOAD PDF BUTTON -->
        <button id="downloadPdfBtn">üì• Download PDF</button>

        <div id="invoicePreview">
            <!-- HEADER -->
            <div class="header">
                <div class="company-details">
                    <div class="invoice">Invoice</div>
                    <div class="company-name" id="p-companyName">GOOGLE INDIA PVT LTD</div>
                    <div class="gst-pan">
                        <div class="gst">
                            <div class="text-block">GSTIN:</div>
                            <div class="text-block semi" id="p-gstin">29AABCG5293F1Z5</div>
                        </div>
                        <div class="pan">
                            <div class="text-block">PAN:</div>
                            <div class="text-block semi" id="p-pan">AABCG5293F</div>
                        </div>
                    </div>
                    <div class="address">
                        <div class="text-block" id="p-companyAddress">3rd Floor, RMZ Infinity Tower E<br>Bangalore, Karnataka, India - 560001</div>
                    </div>
                    <div class="email-phone">
                        <div class="email">
                            <div class="text-block">Email:</div>
                            <div class="text-block semi" id="p-companyEmail">invoices@google.com</div>
                        </div>
                        <div class="phone">
                            <div class="text-block">Phone:</div>
                            <div class="text-block semi" id="p-companyPhone">(+91) 80 6744 5000</div>
                        </div>
                    </div>
                </div>
                <div class="div-block-6">
                    <div class="invoice-details">
                        <div class="logo-container">
                            <img id="p-companyLogo" src="" loading="lazy" alt="Company Logo" class="company-logo" style="display: none;">
                        </div>
                        <div class="invoice-number">
                            <div class="text-block">Invoice No:</div>
                            <div class="text-block semi" id="p-invoiceNumber">GOOG-2025-DEC-001</div>
                        </div>
                        <div class="invoice-date">
                            <div class="text-block">Invoice Date:</div>
                            <div class="text-block semi" id="p-invoiceDate">13th December 2025</div>
                        </div>
                        <div class="export-type">
                            <div class="text-block">Export Type:</div>
                            <div class="text-block semi">Export of Service under LUT</div>
                        </div>
                        <div class="lut-number">
                            <div class="text-block">LUT Reference (ARN):</div>
                            <div class="text-block semi" id="p-lut">AD2302220102614</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="divider-line-1"></div>
            <div class="_2-part-section">
                <div class="part-1">
                    <div class="billing-details">
                        <div class="bill-to">
                            <div class="text-block small">BILL TO:</div>
                            <div class="client-company-name" id="p-clientCompany">Microsoft Corporation</div>
                        </div>
                        <div class="contact-person">
                            <div class="text-block small">CONTACT PERSON:</div>
                            <div class="text-block semi" id="p-clientPerson">John Smith</div>
                        </div>
                        <div class="client-address">
                            <div class="text-block small">ADDRESS:</div>
                            <div class="text-block semi" id="p-clientAddress">One Microsoft Way<br>Redmond, WA, United States - 98052</div>
                        </div>
                        <div class="client-country">
                            <div class="text-block small">COUNTRY:</div>
                            <div class="text-block semi" id="p-clientCountry">United States of America</div>
                        </div>
                        <div class="client-email">
                            <div class="text-block small">EMAIL:</div>
                            <div class="text-block semi" id="p-clientEmail">john.smith@microsoft.com</div>
                        </div>
                        <div class="client-gstin">
                            <div class="text-block small">CLIENT GSTIN:</div>
                            <div class="text-block semi" id="p-clientGSTIN">Unregistered / Overseas</div>
                        </div>
                    </div>
                    <div class="payment-button" id="payBtnBlock" style="display: none;">
                        <a href="#" id="payNowBtn" class="button">
                            Proceed to Payment
                        </a>
                        <div class="text-block small">Click to open secure payment link.</div>
                    </div>
                </div>
                <div class="part-2">
                    <div class="services">
                        <div class="item-details">
                            <div class="nav">
                                <div class="text-block small"><strong>ITEMS</strong></div>
                                <div class="text-block small"><strong>AMOUNT</strong></div>
                            </div>
                            <div id="p-items">
                                <!-- Items will be dynamically added here -->
                            </div>
                        </div>
                        <div class="item-calculation">
                            <div class="total-inr-usd">
                                <div class="total-usd">
                                    <div class="div-block">
                                        <div class="text-block large blue">TOTAL</div>
                                        <div class="text-block small _10-blue">(in <span id="p-totalCurrency">USD</span>)</div>
                                    </div>
                                    <div class="div-block">
                                        <div class="text-block large blue" id="p-totalAmount">$1,050 USD</div>
                                    </div>
                                </div>
                                <div class="total-inr">
                                    <div class="div-block">
                                        <div class="text-block large">INR Equivalent:</div>
                                    </div>
                                    <div class="div-block">
                                        <div class="text-block large" id="p-inrAmount">‚Çπ94,888.71</div>
                                    </div>
                                </div>
                            </div>
                            <div class="rate-signature">
                                <div>
                                    <div class="invoice-currency">
                                        <div class="text-block">Invoice Currency:</div>
                                        <div class="text-block semi" id="p-cur">USD</div>
                                    </div>
                                    <div class="rbi-rate">
                                        <div class="text-block">RBI Exchange Rate:</div>
                                        <div class="text-block semi" id="p-exRate">90.3702</div>
                                    </div>
                                    <div class="gst-amount">
                                        <div class="text-block">GST Amount:</div>
                                        <div class="text-block semi">Nil</div>
                                    </div>
                                    <div class="gst-rate">
                                        <div class="text-block">GST Rate:</div>
                                        <div class="text-block semi">0% (export under LUT)</div>
                                    </div>
                                    <div class="place-of-supply">
                                        <div class="text-block">Place of Supply:</div>
                                        <div class="text-block semi" id="p-place">Karnataka</div>
                                    </div>
                                </div>
                                <div class="div-block-2">
                                    <div class="signature-container">
                                        <img id="p-signatureImage" src="" loading="lazy" alt="Signature" class="signature" style="display: none;">
                                    </div>
                                    <div class="signature-detail">
                                        <div class="text-block semi" id="p-signatureName">SUNDAR PICHAI</div>
                                        <div class="text-block small" id="p-signatureTitle">Authorized Signatory</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="payment-terms">
                        <div class="terms">
                            <div class="text-block semi">PAYMENT TERMS:</div>
                            <div class="text-block" id="p-paymentText">Payment is due within 30 days from the invoice date. You can pay using the account details below or use the payment link provided. For any questions about this invoice, reach out at invoices@google.com</div>
                        </div>
                        <div class="payment-info">
                            <div class="wise-bank-code">
                                <img id="p-qrImage" src="" loading="lazy" alt="QR Code" class="wise-qr" style="display: none;">
                            </div>
                            <div class="div-block-5">
                                <div class="div-block-4" style="display: none; padding-bottom: 10px;">
                                    <div class="text-block semi"><strong>BANK DETAILS</strong></div>
                                </div>
                                <div class="div-block-3" id="bankDetailsBlock" style="display: none;">
                                    <!-- Bank details will be dynamically added here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="declaration">
                        <div class="terms">
                            <div class="text-block semi">EXPORT DECLARATION:</div>
                            <div class="text-block">Supply is meant for export under LUT without payment of IGST. (No IGST Payable)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Dashboard View -->
<div class="dashboard-view" style="display: none;">
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>Invoice Management</h1>
            <button id="createNewInvoiceBtn" class="btn-primary">+ Create New Invoice</button>
        </div>

        <div class="invoices-list">
            <!-- Dynamically populated invoice cards -->
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>

let currentStep = 1;

const steps = document.querySelectorAll(".form-step");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");

function showStep(step) {
  steps.forEach(s => s.classList.remove("active"));
  steps[step - 1].classList.add("active");

  prevBtn.disabled = step === 1;
  nextBtn.textContent = step === steps.length ? "Finish" : "Next";

  // Update step indicator
  updateStepIndicator(step);
}

prevBtn.onclick = () => {
  if (currentStep > 1) {
    currentStep--;
    showStep(currentStep);
  }
};

nextBtn.onclick = () => {
  // If not on the last step, just move to next step
  if (currentStep < steps.length) {
    currentStep++;
    showStep(currentStep);
  }
  // Only finish if we're on the last step AND the button says "Finish"
  else if (currentStep === steps.length && nextBtn.textContent === "Finish") {
    // On last step, "Finish" button creates/saves invoice and returns to dashboard
    finishInvoice();
  }
};

// Finish invoice - creates new invoice or updates existing, then returns to dashboard
function finishInvoice() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    let data = saved ? JSON.parse(saved) : { company: {}, invoices: [], currentInvoiceId: null };

    if (!data.invoices) data.invoices = [];
    if (!data.company) data.company = {};

    // Save company data
    data.company = {
      companyName: document.getElementById("companyName").value,
      gstin: document.getElementById("gstin").value,
      pan: document.getElementById("pan").value,
      companyAddressLine1: document.getElementById("companyAddressLine1").value,
      companyCity: document.getElementById("companyCity").value,
      companyState: document.getElementById("companyState").value,
      companyCountry: document.getElementById("companyCountry").value,
      companyPinCode: document.getElementById("companyPinCode").value,
      companyEmail: document.getElementById("companyEmail").value,
      companyPhone: document.getElementById("companyPhone").value,
      companyLogo: document.getElementById("p-companyLogo").src
    };

    // Create invoice data
    const invoiceData = {
      invoiceNumber: document.getElementById("invoiceNumber").value,
      invoiceDate: document.getElementById("invoiceDate").value,
      lutNumber: document.getElementById("lutNumber").value,
      invoiceCurrency: document.getElementById("invoiceCurrency").value,
      exchangeRate: document.getElementById("exchangeRate").value,
      placeOfSupply: document.getElementById("placeOfSupply").value,

      clientCompany: document.getElementById("clientCompany").value,
      clientPerson: document.getElementById("clientPerson").value,
      clientAddressLine1: document.getElementById("clientAddressLine1").value,
      clientState: document.getElementById("clientState").value,
      clientPinCode: document.getElementById("clientPinCode").value,
      clientCountrySelect: document.getElementById("clientCountrySelect").value,
      clientEmail: document.getElementById("clientEmail").value,
      clientGSTIN: document.getElementById("clientGSTIN").value,

      serviceItems: Array.from(document.querySelectorAll(".item")).map(item => ({
        title: item.querySelector(".title").value,
        desc: item.querySelector(".desc").value,
        sac: item.querySelector(".sac").value,
        amt: item.querySelector(".amt").value
      })),

      supportEmail: document.getElementById("supportEmail").value,
      dueDays: document.getElementById("dueDays").value,
      paymentLink: document.getElementById("paymentLink").value,
      bankDetailsToggle: document.getElementById("bankDetailsToggle").checked,
      bankName: document.getElementById("bankName").value,
      bankHolder: document.getElementById("bankHolder").value,
      bankNumber: document.getElementById("bankNumber").value,
      bankIFSC: document.getElementById("bankIFSC").value,
      bankBranch: document.getElementById("bankBranch").value,
      qrCodeToggle: document.getElementById("qrCodeToggle").checked,
      qrImage: document.getElementById("p-qrImage").src,

      signatureName: document.getElementById("signatureName").value,
      signatureTitle: document.getElementById("signatureTitle").value,
      signatureImage: document.getElementById("p-signatureImage").src
    };

    // If editing existing invoice, update it
    if (currentInvoiceId) {
      const index = data.invoices.findIndex(inv => inv.id === currentInvoiceId);
      if (index !== -1) {
        data.invoices[index] = {
          ...invoiceData,
          id: currentInvoiceId,
          createdAt: data.invoices[index].createdAt,
          updatedAt: new Date().toISOString()
        };
      }
    } else {
      // Create new invoice
      const newInvoice = {
        ...invoiceData,
        id: generateInvoiceId(),
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      data.invoices.push(newInvoice);
    }

    // Reset current invoice ID
    data.currentInvoiceId = null;
    currentInvoiceId = null;

    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));

    // Return to dashboard
    showDashboard();
  } catch (e) {
    console.error("Failed to finish invoice:", e);
  }
}

// Update step indicator when navigating
function updateStepIndicator(step) {
  const stepIndicators = document.querySelectorAll(".step");
  stepIndicators.forEach((stepEl, index) => {
    const stepNum = index + 1;
    stepEl.classList.remove("active", "completed");

    if (stepNum === step) {
      stepEl.classList.add("active");
    } else if (stepNum < step) {
      stepEl.classList.add("completed");
    }
  });
}

// Add click handlers to steps for navigation
document.querySelectorAll(".step").forEach((stepEl, index) => {
  stepEl.addEventListener("click", () => {
    currentStep = index + 1;
    showStep(currentStep);
  });
});

showStep(currentStep);

/* IMAGE TO BASE64 */
function readImage(input, target) {
  if (!input.files[0]) return;
  const reader = new FileReader();
  reader.onload = () => {
    target.src = reader.result;
    target.style.display = "block";
  };
  reader.readAsDataURL(input.files[0]);
}

/* FIELD ‚Üí PREVIEW BINDING */
function bind(id, previewId, formatFn) {
  const el = document.getElementById(id);
  el.addEventListener("input", () => {
    document.getElementById(previewId).textContent =
      formatFn ? formatFn(el.value) : el.value;
  });
}

bind("companyName", "p-companyName");
bind("gstin", "p-gstin");
bind("pan", "p-pan");
bind("companyEmail", "p-companyEmail");
bind("companyPhone", "p-companyPhone");

/* Company Address Handler */
function updateCompanyAddress() {
  const line1 = document.getElementById("companyAddressLine1").value;
  const city = document.getElementById("companyCity").value;
  const state = document.getElementById("companyState").value;
  const country = document.getElementById("companyCountry").value;
  const pinCode = document.getElementById("companyPinCode").value;

  const line2Parts = [city, state, country, pinCode].filter(Boolean);
  const line2 = line2Parts.join(", ");

  document.getElementById("p-companyAddress").innerHTML =
    line1 + (line2 ? "<br>" + line2 : "");
}

["companyAddressLine1", "companyCity", "companyState", "companyCountry", "companyPinCode"]
  .forEach(id => {
    document.getElementById(id).addEventListener("input", updateCompanyAddress);
  });
bind("invoiceNumber", "p-invoiceNumber");
bind("invoiceCurrency", "p-currency");
bind("lutNumber", "p-lut");
bind("clientCompany", "p-clientCompany");
bind("clientPerson", "p-clientPerson");
bind("clientEmail", "p-clientEmail");
bind("clientGSTIN", "p-clientGSTIN");
bind("placeOfSupply", "p-place");

/* Client Address Handler */
function updateClientAddress() {
  const line1 = document.getElementById("clientAddressLine1").value;
  const state = document.getElementById("clientState").value;
  const country = document.getElementById("clientCountrySelect").value;
  const pinCode = document.getElementById("clientPinCode").value;

  const line2Parts = [state, country, pinCode].filter(Boolean);
  const line2 = line2Parts.join(", ");

  document.getElementById("p-clientAddress").innerHTML =
    line1 + (line2 ? "<br>" + line2 : "");

  // Also update country in preview header
  document.getElementById("p-clientCountry").textContent = country;
}

["clientAddressLine1", "clientState", "clientCountrySelect", "clientPinCode"]
  .forEach(id => {
    document.getElementById(id).addEventListener("input", updateClientAddress);
  });

document.getElementById("invoiceDate").addEventListener("input", e => {
  const date = new Date(e.target.value);
  const day = date.getDate();
  const ordinal = (day) => {
    const s = ["th", "st", "nd", "rd"];
    const v = day % 100;
    return day + (s[(v - 20) % 10] || s[v] || s[0]);
  };
  const month = date.toLocaleString('en-US', { month: 'long' });
  const year = date.getFullYear();
  document.getElementById("p-invoiceDate").textContent = `${ordinal(day)} ${month} ${year}`;
});

/* LOGO */
document.getElementById("companyLogo").addEventListener("change", e => {
  readImage(e.target, document.getElementById("p-companyLogo"));
});

/* SIGNATURE */
document.getElementById("signatureImage").addEventListener("change", e => {
  readImage(e.target, document.getElementById("p-signatureImage"));
});

bind("signatureName", "p-signatureName");
bind("signatureTitle", "p-signatureTitle");

/* PAYMENT */
document.getElementById("paymentLink").addEventListener("input", e => {
  const link = e.target.value;
  const block = document.getElementById("payBtnBlock");
  const btn = document.getElementById("payNowBtn");

  if (link) {
    btn.href = link;
    block.style.display = "flex";
  } else {
    block.style.display = "none";
  }
});

document.getElementById("bankDetailsToggle").addEventListener("change", e => {
  document.getElementById("bankContainer").classList.toggle("hidden", !e.target.checked);
  const bankBlock = document.getElementById("bankDetailsBlock");
  bankBlock.style.display = e.target.checked ? "flex" : "none";
  const bankLabel = document.querySelector(".div-block-4");
  bankLabel.style.display = e.target.checked ? "block" : "none";
  // Hide entire Payment Terms section when toggle is off
  const paymentTermsSection = document.querySelector(".payment-terms");
  paymentTermsSection.style.display = e.target.checked ? "block" : "none";
});

/* QR CODE TOGGLE */
document.getElementById("qrCodeToggle").addEventListener("change", e => {
  document.getElementById("qrCodeContainer").classList.toggle("hidden", !e.target.checked);
  const qrImg = document.getElementById("p-qrImage");
  const qrContainer = document.querySelector(".wise-bank-code");
  if (!e.target.checked) {
    qrImg.style.display = "none";
    qrContainer.style.display = "none";
  } else {
    qrContainer.style.display = "block";
  }
});

/* CURRENCY SYMBOL HELPER */
function getCurrencySymbol(currency) {
  const symbols = {
    'USD': '$',
    'EUR': '‚Ç¨',
    'GBP': '¬£',
    'AUD': 'A$',
    'CAD': 'C$'
  };
  return symbols[currency] || currency;
}

/* INR NUMBER FORMATTER (Indian numbering system) */
function formatINR(number) {
  if (!number || isNaN(number)) return "0.00";

  // Convert to string and split into integer and decimal parts
  const parts = number.toFixed(2).split(".");
  const integerPart = parts[0];
  const decimalPart = parts[1];

  // Indian numbering system: last 3 digits, then groups of 2
  let formatted = "";
  const length = integerPart.length;

  if (length <= 3) {
    formatted = integerPart;
  } else {
    // Last 3 digits
    formatted = integerPart.slice(-3);
    let remaining = integerPart.slice(0, -3);

    // Add commas every 2 digits from right to left
    while (remaining.length > 0) {
      if (remaining.length <= 2) {
        formatted = remaining + "," + formatted;
        remaining = "";
      } else {
        formatted = remaining.slice(-2) + "," + formatted;
        remaining = remaining.slice(0, -2);
      }
    }
  }

  return formatted + "." + decimalPart;
}

/* ITEMS */
const itemsContainer = document.getElementById("itemsContainer");
const previewItems = document.getElementById("p-items");

document.getElementById("addItemBtn").onclick = () => {
  const idx = document.querySelectorAll(".item").length + 1;

  const div = document.createElement("div");
  div.className = "item";
  div.innerHTML = `
    <label>Title</label><input class="title">
    <label>Description</label><textarea class="desc"></textarea>
    <label>SAC</label><input class="sac">
    <label>Amount</label><input type="number" class="amt">
    <button type="button" class="delete-item-btn" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 8px 16px; cursor: pointer; font-size: 12px; font-weight: 600; margin-top: 12px; width: 100%;">Delete Item</button>
    <hr>
  `;
  itemsContainer.appendChild(div);

  div.querySelectorAll("input,textarea").forEach(i =>
    i.addEventListener("input", updateItems)
  );

  // Add delete button handler
  div.querySelector(".delete-item-btn").addEventListener("click", () => {
    div.remove();
    updateItems();
    // Save after deleting item
    setTimeout(autoSave, 100);
  });
};

function updateItems() {
  previewItems.innerHTML = "";
  let total = 0;
  const currency = document.getElementById("invoiceCurrency").value;
  const currencySymbol = getCurrencySymbol(currency);

  document.querySelectorAll(".item").forEach(item => {
    const title = item.querySelector(".title").value;
    const desc = item.querySelector(".desc").value;
    const sac = item.querySelector(".sac").value;
    const amt = Number(item.querySelector(".amt").value || 0);
    total += amt;

    previewItems.innerHTML += `
      <div class="items">
        <div class="service-details">
          <div class="text-block large">${title}</div>
          <div class="text-block">${desc}</div>
          <div class="phone">
            <div class="text-block">SAC:</div>
            <div class="text-block semi">${sac}</div>
          </div>
        </div>
        <div class="cost">
          <div class="text-block large">${currencySymbol}${amt.toFixed(2)} ${currency}</div>
        </div>
      </div>
    `;
  });

  document.getElementById("p-totalCurrency").textContent = currency;
  document.getElementById("p-totalAmount").textContent = currencySymbol + total.toFixed(2) + " " + currency;
  document.getElementById("p-cur").textContent = currency;

  const rate = Number(document.getElementById("exchangeRate").value || 0);
  const inrTotal = total * rate;
  document.getElementById("p-exRate").textContent = rate;
  document.getElementById("p-inrAmount").textContent =
    "‚Çπ " + formatINR(inrTotal);
}

/* UPDATE PAYMENT TERMS TEXT */
function updatePaymentTerms() {
  const supportEmail = document.getElementById("supportEmail").value;
  const dueDays = document.getElementById("dueDays").value;
  const paymentText = document.getElementById("p-paymentText");

  if (dueDays && supportEmail) {
    paymentText.textContent = `Payment is due within ${dueDays} days from the invoice date. You can pay using the account details below or use the payment link provided. For any questions about this invoice, reach out at ${supportEmail}`;
  } else {
    paymentText.textContent = "Payment terms will appear here once you fill the required fields.";
  }
}

document.getElementById("supportEmail").addEventListener("input", updatePaymentTerms);
document.getElementById("dueDays").addEventListener("input", updatePaymentTerms);

/* UPDATE BANK DETAILS */
function updateBankDetails() {
  const bankName = document.getElementById("bankName").value;
  const bankHolder = document.getElementById("bankHolder").value;
  const bankNumber = document.getElementById("bankNumber").value;
  const bankIFSC = document.getElementById("bankIFSC").value;
  const bankBranch = document.getElementById("bankBranch").value;
  const bankBlock = document.getElementById("bankDetailsBlock");

  if (bankName || bankHolder || bankNumber) {
    bankBlock.innerHTML = `
      <div class="bank-details">
        <div class="bank"><div class="text-block">Bank:</div></div>
        <div class="bank"><div class="text-block">Account Holder:</div></div>
        <div class="bank"><div class="text-block">Account Number:</div></div>
        <div class="bank"><div class="text-block">IFSC Code:</div></div>
        <div class="bank"><div class="text-block">Bank Branch:</div></div>
      </div>
      <div class="bank-details-1">
        <div class="bank"><div class="text-block semi"><strong>${bankName}</strong></div></div>
        <div class="bank"><div class="text-block semi"><strong>${bankHolder}</strong></div></div>
        <div class="bank"><div class="text-block semi"><strong>${bankNumber}</strong></div></div>
        <div class="bank"><div class="text-block semi"><strong>${bankIFSC}</strong></div></div>
        <div class="bank"><div class="text-block semi"><strong>${bankBranch}</strong></div></div>
      </div>
    `;
  }
}

document.getElementById("bankName").addEventListener("input", updateBankDetails);
document.getElementById("bankHolder").addEventListener("input", updateBankDetails);
document.getElementById("bankNumber").addEventListener("input", updateBankDetails);
document.getElementById("bankIFSC").addEventListener("input", updateBankDetails);
document.getElementById("bankBranch").addEventListener("input", updateBankDetails);

document.getElementById("qrImage").addEventListener("change", e => {
  const qrImg = document.getElementById("p-qrImage");
  const qrContainer = document.querySelector(".wise-bank-code");
  readImage(e.target, qrImg);
  // Show QR container when image is uploaded
  if (e.target.files[0]) {
    qrContainer.style.display = "block";
  }
});

/* EXCHANGE RATE UPDATE */
document.getElementById("exchangeRate").addEventListener("input", updateItems);
document.getElementById("invoiceCurrency").addEventListener("input", updateItems);

/* PDF DOWNLOAD FUNCTIONALITY */
document.getElementById("downloadPdfBtn").addEventListener("click", async function() {
  const button = this;
  const originalText = button.textContent;
  button.textContent = "Generating PDF...";
  button.disabled = true;

  try {
    const invoice = document.getElementById("invoicePreview");

    // Store original styles
    const originalMaxWidth = invoice.style.maxWidth;
    const originalPadding = invoice.style.padding;

    // Temporarily set to full width with no padding for PDF
    invoice.style.maxWidth = '1000px';  // Original Webflow design width
    invoice.style.padding = '40px';

    // Wait for reflow
    await new Promise(resolve => setTimeout(resolve, 100));

    // Use html2canvas to capture the invoice with optimized quality
    const canvas = await html2canvas(invoice, {
      scale: 1.5,            // Optimized for file size while maintaining quality
      useCORS: true,
      logging: false,
      backgroundColor: "#ffffff",
      letterRendering: true  // Preserve letter spacing
    });

    // Restore original styles immediately
    invoice.style.maxWidth = originalMaxWidth;
    invoice.style.padding = originalPadding;

    // A4 page dimensions - use full width (no margins)
    const pageWidth = 210;    // A4 width in mm
    const pageHeight = 297;   // A4 height in mm

    // Calculate image dimensions to fill page width
    let imgWidth = pageWidth;
    let imgHeight = (canvas.height * imgWidth) / canvas.width;

    // If content exceeds page height, add multiple pages
    let position = 0;
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({
      orientation: "portrait",
      unit: "mm",
      format: "a4"
    });

    const imgData = canvas.toDataURL("image/jpeg", 0.85);  // JPEG with 85% quality for smaller file size

    // Add image to fill full page width
    if (imgHeight <= pageHeight) {
      // Single page - align to top (no vertical centering for professional appearance)
      pdf.addImage(imgData, "JPEG", 0, 0, imgWidth, imgHeight);
    } else {
      // Multiple pages needed
      while (position < canvas.height) {
        const pageCanvas = document.createElement('canvas');
        pageCanvas.width = canvas.width;
        pageCanvas.height = Math.min(
          canvas.height - position,
          (pageHeight / imgWidth) * canvas.width
        );

        const ctx = pageCanvas.getContext('2d');
        ctx.drawImage(
          canvas,
          0, position,
          canvas.width, pageCanvas.height,
          0, 0,
          pageCanvas.width, pageCanvas.height
        );

        const pageData = pageCanvas.toDataURL("image/jpeg", 0.85);  // JPEG for smaller file size
        const pageImgHeight = (pageCanvas.height * imgWidth) / pageCanvas.width;

        if (position > 0) {
          pdf.addPage();
        }

        pdf.addImage(pageData, "JPEG", 0, 0, imgWidth, pageImgHeight);

        position += pageCanvas.height;
      }
    }

    // Generate filename from invoice number
    const invoiceNum = document.getElementById("invoiceNumber").value || "invoice";
    const filename = `${invoiceNum.replace(/\s+/g, '-')}.pdf`;

    pdf.save(filename);

    button.textContent = "‚úì Downloaded!";
    setTimeout(() => {
      button.textContent = originalText;
      button.disabled = false;
    }, 2000);
  } catch (error) {
    console.error("PDF generation failed:", error);
    button.textContent = "Error - Try Again";
    setTimeout(() => {
      button.textContent = originalText;
      button.disabled = false;
    }, 2000);
  }
});

/* LOCALSTORAGE PERSISTENCE */
const STORAGE_KEY = 'invoiceToolData';
let currentInvoiceId = null; // null = new invoice, "inv_123" = editing existing

// Migrate old single-invoice data to new multi-invoice structure
function migrateToMultiInvoice() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (!saved) return; // No data to migrate

    const data = JSON.parse(saved);

    // Check if already migrated (has 'invoices' array)
    if (data.invoices) return;

    // This is old single-invoice data - migrate it
    const migratedData = {
      company: {
        companyName: data.companyName || "",
        gstin: data.gstin || "",
        pan: data.pan || "",
        companyAddressLine1: data.companyAddressLine1 || "",
        companyCity: data.companyCity || "",
        companyState: data.companyState || "",
        companyCountry: data.companyCountry || "",
        companyPinCode: data.companyPinCode || "",
        companyEmail: data.companyEmail || "",
        companyPhone: data.companyPhone || "",
        companyLogo: data.companyLogo || ""
      },
      invoices: [
        {
          id: generateInvoiceId(),
          invoiceNumber: data.invoiceNumber || "",
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),

          // Steps 2-6 data
          invoiceDate: data.invoiceDate || "",
          lutNumber: data.lutNumber || "",
          invoiceCurrency: data.invoiceCurrency || "",
          exchangeRate: data.exchangeRate || "",
          placeOfSupply: data.placeOfSupply || "",

          clientCompany: data.clientCompany || "",
          clientPerson: data.clientPerson || "",
          clientAddressLine1: data.clientAddressLine1 || "",
          clientState: data.clientState || "",
          clientPinCode: data.clientPinCode || "",
          clientCountrySelect: data.clientCountrySelect || "",
          clientEmail: data.clientEmail || "",
          clientGSTIN: data.clientGSTIN || "",

          serviceItems: data.serviceItems || [],

          supportEmail: data.supportEmail || "",
          dueDays: data.dueDays || "",
          paymentLink: data.paymentLink || "",
          bankDetailsToggle: data.bankDetailsToggle || false,
          bankName: data.bankName || "",
          bankHolder: data.bankHolder || "",
          bankNumber: data.bankNumber || "",
          bankIFSC: data.bankIFSC || "",
          bankBranch: data.bankBranch || "",
          qrCodeToggle: data.qrCodeToggle || false,
          qrImage: data.qrImage || "",

          signatureName: data.signatureName || "",
          signatureTitle: data.signatureTitle || "",
          signatureImage: data.signatureImage || ""
        }
      ],
      currentInvoiceId: null
    };

    localStorage.setItem(STORAGE_KEY, JSON.stringify(migratedData));
    console.log("Successfully migrated single-invoice data to multi-invoice structure");
  } catch (e) {
    console.error("Failed to migrate data:", e);
  }
}

// Helper function to generate unique invoice ID
function generateInvoiceId() {
  return 'inv_' + Date.now();
}

// Helper function to calculate invoice total
function calculateInvoiceTotal(invoice) {
  if (!invoice.serviceItems) return 0;
  return invoice.serviceItems.reduce((sum, item) => {
    return sum + (parseFloat(item.amt) || 0);
  }, 0);
}

// Save all form data to localStorage (multi-invoice structure)
function saveToLocalStorage() {
  try {
    // Get existing data or create new structure
    const saved = localStorage.getItem(STORAGE_KEY);
    let data = saved ? JSON.parse(saved) : { company: {}, invoices: [], currentInvoiceId: null };

    // Ensure data structure exists
    if (!data.invoices) data.invoices = [];
    if (!data.company) data.company = {};

    // Save company data (Step 1)
    data.company = {
      companyName: document.getElementById("companyName").value,
      gstin: document.getElementById("gstin").value,
      pan: document.getElementById("pan").value,
      companyAddressLine1: document.getElementById("companyAddressLine1").value,
      companyCity: document.getElementById("companyCity").value,
      companyState: document.getElementById("companyState").value,
      companyCountry: document.getElementById("companyCountry").value,
      companyPinCode: document.getElementById("companyPinCode").value,
      companyEmail: document.getElementById("companyEmail").value,
      companyPhone: document.getElementById("companyPhone").value,
      companyLogo: document.getElementById("p-companyLogo").src
    };

    // Create invoice object (Steps 2-6)
    const invoiceData = {
      // Step 2: Invoice Details
      invoiceNumber: document.getElementById("invoiceNumber").value,
      invoiceDate: document.getElementById("invoiceDate").value,
      lutNumber: document.getElementById("lutNumber").value,
      invoiceCurrency: document.getElementById("invoiceCurrency").value,
      exchangeRate: document.getElementById("exchangeRate").value,
      placeOfSupply: document.getElementById("placeOfSupply").value,

      // Step 3: Client Information
      clientCompany: document.getElementById("clientCompany").value,
      clientPerson: document.getElementById("clientPerson").value,
      clientAddressLine1: document.getElementById("clientAddressLine1").value,
      clientState: document.getElementById("clientState").value,
      clientPinCode: document.getElementById("clientPinCode").value,
      clientCountrySelect: document.getElementById("clientCountrySelect").value,
      clientEmail: document.getElementById("clientEmail").value,
      clientGSTIN: document.getElementById("clientGSTIN").value,

      // Step 4: Service Items (dynamic)
      serviceItems: Array.from(document.querySelectorAll(".item")).map(item => ({
        title: item.querySelector(".title").value,
        desc: item.querySelector(".desc").value,
        sac: item.querySelector(".sac").value,
        amt: item.querySelector(".amt").value
      })),

      // Step 5: Payment Terms
      supportEmail: document.getElementById("supportEmail").value,
      dueDays: document.getElementById("dueDays").value,
      paymentLink: document.getElementById("paymentLink").value,
      bankDetailsToggle: document.getElementById("bankDetailsToggle").checked,
      bankName: document.getElementById("bankName").value,
      bankHolder: document.getElementById("bankHolder").value,
      bankNumber: document.getElementById("bankNumber").value,
      bankIFSC: document.getElementById("bankIFSC").value,
      bankBranch: document.getElementById("bankBranch").value,
      qrCodeToggle: document.getElementById("qrCodeToggle").checked,
      qrImage: document.getElementById("p-qrImage").src,

      // Step 6: Signature
      signatureName: document.getElementById("signatureName").value,
      signatureTitle: document.getElementById("signatureTitle").value,
      signatureImage: document.getElementById("p-signatureImage").src
    };

    // Only save/update invoice if we're editing an existing one
    // For new invoices, only save company data until user clicks Finish
    if (currentInvoiceId) {
      const index = data.invoices.findIndex(inv => inv.id === currentInvoiceId);
      if (index !== -1) {
        // Update existing invoice
        data.invoices[index] = {
          ...invoiceData,
          id: currentInvoiceId,
          createdAt: data.invoices[index].createdAt,
          updatedAt: new Date().toISOString()
        };
      }
    }
    // Note: If currentInvoiceId is null, we're creating a new invoice
    // Don't add it to invoices array yet - wait for user to click Finish

    // Save current invoice ID
    data.currentInvoiceId = currentInvoiceId;

    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  } catch (e) {
    console.error("Failed to save to localStorage:", e);
  }
}

// Restore all form data from localStorage (multi-invoice structure)
function restoreFromLocalStorage() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (!saved) return false; // No saved data exists

    const data = JSON.parse(saved);
    if (!data.company && !data.invoices) return false; // Invalid data structure

    // Always restore company data (Step 1)
    if (data.company) {
      document.getElementById("companyName").value = data.company.companyName || "";
      document.getElementById("gstin").value = data.company.gstin || "";
      document.getElementById("pan").value = data.company.pan || "";
      document.getElementById("companyAddressLine1").value = data.company.companyAddressLine1 || "";
      document.getElementById("companyCity").value = data.company.companyCity || "";
      document.getElementById("companyState").value = data.company.companyState || "";
      document.getElementById("companyCountry").value = data.company.companyCountry || "";
      document.getElementById("companyPinCode").value = data.company.companyPinCode || "";
      document.getElementById("companyEmail").value = data.company.companyEmail || "";
      document.getElementById("companyPhone").value = data.company.companyPhone || "";

      // Restore company logo
      if (data.company.companyLogo && data.company.companyLogo !== "" && !data.company.companyLogo.endsWith("/")) {
        document.getElementById("p-companyLogo").src = data.company.companyLogo;
        document.getElementById("p-companyLogo").style.display = "block";
      }
    }

    // If editing an invoice, restore invoice data (Steps 2-6)
    if (currentInvoiceId && data.invoices) {
      const invoice = data.invoices.find(inv => inv.id === currentInvoiceId);
      if (invoice) {
        // Step 2: Invoice Details
        document.getElementById("invoiceNumber").value = invoice.invoiceNumber || "";
        document.getElementById("invoiceDate").value = invoice.invoiceDate || "";
        document.getElementById("lutNumber").value = invoice.lutNumber || "";
        document.getElementById("invoiceCurrency").value = invoice.invoiceCurrency || "USD";
        document.getElementById("exchangeRate").value = invoice.exchangeRate || "";
        document.getElementById("placeOfSupply").value = invoice.placeOfSupply || "Karnataka";

        // Step 3: Client Information
        document.getElementById("clientCompany").value = invoice.clientCompany || "";
        document.getElementById("clientPerson").value = invoice.clientPerson || "";
        document.getElementById("clientAddressLine1").value = invoice.clientAddressLine1 || "";
        document.getElementById("clientState").value = invoice.clientState || "";
        document.getElementById("clientPinCode").value = invoice.clientPinCode || "";
        document.getElementById("clientCountrySelect").value = invoice.clientCountrySelect || "United States of America";
        document.getElementById("clientEmail").value = invoice.clientEmail || "";
        document.getElementById("clientGSTIN").value = invoice.clientGSTIN || "";

        // Step 4: Service Items (dynamic restoration)
        if (invoice.serviceItems && invoice.serviceItems.length > 0) {
          // Clear existing items first
          document.querySelectorAll(".item").forEach(item => item.remove());

          // Add each saved item
          invoice.serviceItems.forEach(itemData => {
            document.getElementById("addItemBtn").click();

            // Wait for DOM update, then populate the last added item
            setTimeout(() => {
              const items = document.querySelectorAll(".item");
              const lastItem = items[items.length - 1];
              if (lastItem) {
                lastItem.querySelector(".title").value = itemData.title || "";
                lastItem.querySelector(".desc").value = itemData.desc || "";
                lastItem.querySelector(".sac").value = itemData.sac || "";
                lastItem.querySelector(".amt").value = itemData.amt || "";

                // Trigger input events to update preview
                lastItem.querySelector(".title").dispatchEvent(new Event("input"));
                lastItem.querySelector(".desc").dispatchEvent(new Event("input"));
                lastItem.querySelector(".sac").dispatchEvent(new Event("input"));
                lastItem.querySelector(".amt").dispatchEvent(new Event("input"));
              }
            }, 10);
          });
        }

        // Step 5: Payment Terms
        document.getElementById("supportEmail").value = invoice.supportEmail || "";
        document.getElementById("dueDays").value = invoice.dueDays || "";
        document.getElementById("paymentLink").value = invoice.paymentLink || "";

        // Restore bank details toggle
        document.getElementById("bankDetailsToggle").checked = invoice.bankDetailsToggle || false;
        document.getElementById("bankDetailsToggle").dispatchEvent(new Event("change"));

        document.getElementById("bankName").value = invoice.bankName || "";
        document.getElementById("bankHolder").value = invoice.bankHolder || "";
        document.getElementById("bankNumber").value = invoice.bankNumber || "";
        document.getElementById("bankIFSC").value = invoice.bankIFSC || "";
        document.getElementById("bankBranch").value = invoice.bankBranch || "";

        // Restore QR toggle
        document.getElementById("qrCodeToggle").checked = invoice.qrCodeToggle || false;
        document.getElementById("qrCodeToggle").dispatchEvent(new Event("change"));

        // Restore QR image
        if (invoice.qrImage && invoice.qrImage !== "" && !invoice.qrImage.endsWith("/")) {
          document.getElementById("p-qrImage").src = invoice.qrImage;
          document.getElementById("p-qrImage").style.display = "block";
          document.querySelector(".wise-bank-code").style.display = "block";
        }

        // Step 6: Signature
        document.getElementById("signatureName").value = invoice.signatureName || "";
        document.getElementById("signatureTitle").value = invoice.signatureTitle || "";

        // Restore signature image
        if (invoice.signatureImage && invoice.signatureImage !== "" && !invoice.signatureImage.endsWith("/")) {
          document.getElementById("p-signatureImage").src = invoice.signatureImage;
          document.getElementById("p-signatureImage").style.display = "block";
        }
      }
    }

    // Trigger all input events to update previews
    setTimeout(() => {
      document.getElementById("companyName").dispatchEvent(new Event("input"));
      document.getElementById("gstin").dispatchEvent(new Event("input"));
      document.getElementById("pan").dispatchEvent(new Event("input"));
      document.getElementById("companyAddressLine1").dispatchEvent(new Event("input"));
      document.getElementById("companyCity").dispatchEvent(new Event("input"));
      document.getElementById("companyState").dispatchEvent(new Event("input"));
      document.getElementById("companyCountry").dispatchEvent(new Event("input"));
      document.getElementById("companyPinCode").dispatchEvent(new Event("input"));
      document.getElementById("companyEmail").dispatchEvent(new Event("input"));
      document.getElementById("companyPhone").dispatchEvent(new Event("input"));
      document.getElementById("invoiceNumber").dispatchEvent(new Event("input"));
      document.getElementById("invoiceDate").dispatchEvent(new Event("input"));
      document.getElementById("lutNumber").dispatchEvent(new Event("input"));
      document.getElementById("clientCompany").dispatchEvent(new Event("input"));
      document.getElementById("clientPerson").dispatchEvent(new Event("input"));
      document.getElementById("clientAddressLine1").dispatchEvent(new Event("input"));
      document.getElementById("clientState").dispatchEvent(new Event("input"));
      document.getElementById("clientPinCode").dispatchEvent(new Event("input"));
      document.getElementById("clientCountrySelect").dispatchEvent(new Event("input"));
      document.getElementById("clientEmail").dispatchEvent(new Event("input"));
      document.getElementById("clientGSTIN").dispatchEvent(new Event("input"));
      document.getElementById("placeOfSupply").dispatchEvent(new Event("input"));
      document.getElementById("signatureName").dispatchEvent(new Event("input"));
      document.getElementById("signatureTitle").dispatchEvent(new Event("input"));
      document.getElementById("paymentLink").dispatchEvent(new Event("input"));
      document.getElementById("supportEmail").dispatchEvent(new Event("input"));
      document.getElementById("dueDays").dispatchEvent(new Event("input"));
      updatePaymentTerms();
      updateBankDetails();
    }, 100);

    return true; // Successfully restored
  } catch (e) {
    console.error("Failed to restore from localStorage:", e);
    return false;
  }
}

// Clear saved data from localStorage
function clearLocalStorage() {
  localStorage.removeItem(STORAGE_KEY);
}

// Get all invoices sorted by date (newest first)
function getAllInvoices() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (!saved) return [];

    const data = JSON.parse(saved);
    if (!data.invoices) return [];

    // Sort by createdAt date, newest first
    return data.invoices.sort((a, b) => {
      return new Date(b.createdAt) - new Date(a.createdAt);
    });
  } catch (e) {
    console.error("Failed to get invoices:", e);
    return [];
  }
}

// Delete an invoice by ID
function deleteInvoice(id) {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (!saved) return;

    const data = JSON.parse(saved);
    if (!data.invoices) return;

    // Filter out the invoice with matching ID
    data.invoices = data.invoices.filter(inv => inv.id !== id);

    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  } catch (e) {
    console.error("Failed to delete invoice:", e);
  }
}

// Clear all preview elements (used when creating new invoice)
function clearPreview() {
  console.log('clearPreview() called');
  try {
    // Company preview
    const pCompanyName = document.getElementById("p-companyName");
    if (pCompanyName) pCompanyName.textContent = "";

    const pGstin = document.getElementById("p-gstin");
    if (pGstin) pGstin.textContent = "";

    const pPan = document.getElementById("p-pan");
    if (pPan) pPan.textContent = "";

    const pCompanyAddress = document.getElementById("p-companyAddress");
    if (pCompanyAddress) pCompanyAddress.innerHTML = "";

    const pCompanyEmail = document.getElementById("p-companyEmail");
    if (pCompanyEmail) pCompanyEmail.textContent = "";

    const pCompanyPhone = document.getElementById("p-companyPhone");
    if (pCompanyPhone) pCompanyPhone.textContent = "";

    const companyLogo = document.getElementById("p-companyLogo");
    if (companyLogo) {
      companyLogo.src = "";
      companyLogo.style.display = "none";
    }

  // Invoice details
  document.getElementById("p-invoiceNumber").textContent = "";
  const invoiceDate = document.getElementById("p-invoiceDate");
  if (invoiceDate) invoiceDate.textContent = "";
  const lut = document.getElementById("p-lut");
  if (lut) lut.textContent = "";
  document.getElementById("p-currency").textContent = "";
  const place = document.getElementById("p-place");
  if (place) place.textContent = "";

  // Client preview
  document.getElementById("p-clientCompany").textContent = "";
  const clientPerson = document.getElementById("p-clientPerson");
  if (clientPerson) clientPerson.textContent = "";
  document.getElementById("p-clientAddress").innerHTML = "";
  const clientEmail = document.getElementById("p-clientEmail");
  if (clientEmail) clientEmail.textContent = "";
  const clientGSTIN = document.getElementById("p-clientGSTIN");
  if (clientGSTIN) clientGSTIN.textContent = "";
  document.getElementById("p-clientCountry").textContent = "";

  // Items table - clear all rows
  const itemsTableBody = document.querySelector(".table-body");
  if (itemsTableBody) itemsTableBody.innerHTML = "";

  // Totals
  const subtotal = document.getElementById("p-subtotal");
  if (subtotal) subtotal.textContent = "0.00";
  const igst = document.getElementById("p-igst");
  if (igst) igst.textContent = "0.00";
  const total = document.getElementById("p-total");
  if (total) total.textContent = "0.00";

  // Payment
  const paymentText = document.getElementById("p-paymentText");
  if (paymentText) paymentText.textContent = "";
  const payBtnBlock = document.getElementById("payBtnBlock");
  if (payBtnBlock) payBtnBlock.style.display = "none";

  // Bank details
  const bankDetailsBlock = document.getElementById("bankDetailsBlock");
  if (bankDetailsBlock) bankDetailsBlock.style.display = "none";

  // Signature
  const signatureName = document.getElementById("p-signatureName");
  if (signatureName) signatureName.textContent = "";
  const signatureTitle = document.getElementById("p-signatureTitle");
  if (signatureTitle) signatureTitle.textContent = "";
  const signatureImage = document.getElementById("p-signatureImage");
  if (signatureImage) {
    signatureImage.src = "";
    signatureImage.style.display = "none";
  }

  // QR code
  const qrImage = document.getElementById("p-qrImage");
  if (qrImage) {
    qrImage.src = "";
    qrImage.style.display = "none";
  }
  const qrContainer = document.querySelector(".wise-bank-code");
  if (qrContainer) qrContainer.style.display = "none";

    console.log('clearPreview() completed successfully');
  } catch (error) {
    console.error('Error in clearPreview():', error);
  }
}

// Set which invoice is being edited (null for new invoice)
function setCurrentInvoice(id) {
  currentInvoiceId = id;

  // Also update in localStorage
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const data = JSON.parse(saved);
      data.currentInvoiceId = id;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }
  } catch (e) {
    console.error("Failed to set current invoice:", e);
  }
}

// Clear invoice form for NEW invoice with smart data reuse
function clearInvoiceForm() {
  console.log('clearInvoiceForm() called');
  try {
    // Show sample data in preview (form stays empty)
    try {
      loadSampleDataToPreview();
      console.log('Sample data loaded to preview');
    } catch (previewError) {
      console.error('Failed to load preview, continuing anyway:', previewError);
      // Continue execution even if preview fails
    }

  // Check if user has created any real invoices (not the sample)
  const saved = localStorage.getItem(STORAGE_KEY);
  let shouldRestoreUserData = false;
  let userData = null;

  if (saved) {
    const data = JSON.parse(saved);
    // Get user-created invoices (exclude sample invoice)
    const userInvoices = data.invoices ? data.invoices.filter(inv => inv.id !== 'sample_invoice_001') : [];

    if (userInvoices.length > 0) {
      shouldRestoreUserData = true;
      // Get most recent user invoice for reference data
      const latestUserInvoice = userInvoices[0];
      userData = {
        company: data.company,
        payment: {
          supportEmail: latestUserInvoice.supportEmail,
          dueDays: latestUserInvoice.dueDays,
          paymentLink: latestUserInvoice.paymentLink,
          bankDetailsToggle: latestUserInvoice.bankDetailsToggle,
          bankName: latestUserInvoice.bankName,
          bankHolder: latestUserInvoice.bankHolder,
          bankNumber: latestUserInvoice.bankNumber,
          bankIFSC: latestUserInvoice.bankIFSC,
          bankBranch: latestUserInvoice.bankBranch,
          qrCodeToggle: latestUserInvoice.qrCodeToggle,
          qrImage: latestUserInvoice.qrImage
        },
        signature: {
          signatureName: latestUserInvoice.signatureName,
          signatureTitle: latestUserInvoice.signatureTitle,
          signatureImage: latestUserInvoice.signatureImage
        }
      };
    }
  }

  // Step 1: Company info - restore if user has created invoices before
  if (shouldRestoreUserData && userData.company) {
    document.getElementById("companyName").value = userData.company.companyName || "";
    document.getElementById("gstin").value = userData.company.gstin || "";
    document.getElementById("pan").value = userData.company.pan || "";
    document.getElementById("companyAddressLine1").value = userData.company.companyAddressLine1 || "";
    document.getElementById("companyCity").value = userData.company.companyCity || "";
    document.getElementById("companyState").value = userData.company.companyState || "";
    document.getElementById("companyCountry").value = userData.company.companyCountry || "";
    document.getElementById("companyPinCode").value = userData.company.companyPinCode || "";
    document.getElementById("companyEmail").value = userData.company.companyEmail || "";
    document.getElementById("companyPhone").value = userData.company.companyPhone || "";
    if (userData.company.companyLogo) {
      document.getElementById("p-companyLogo").src = userData.company.companyLogo;
      document.getElementById("p-companyLogo").style.display = "block";
    }
  } else {
    // Clear company info for first-time users
    document.getElementById("companyName").value = "";
    document.getElementById("gstin").value = "";
    document.getElementById("pan").value = "";
    document.getElementById("companyAddressLine1").value = "";
    document.getElementById("companyCity").value = "";
    document.getElementById("companyState").value = "";
    document.getElementById("companyCountry").value = "";
    document.getElementById("companyPinCode").value = "";
    document.getElementById("companyEmail").value = "";
    document.getElementById("companyPhone").value = "";
    document.getElementById("p-companyLogo").src = "";
    document.getElementById("p-companyLogo").style.display = "none";
  }

  // Step 2: Clear invoice-specific details (always)
  document.getElementById("invoiceNumber").value = "";
  document.getElementById("invoiceDate").value = "";
  document.getElementById("lutNumber").value = "";
  document.getElementById("invoiceCurrency").value = "USD";
  document.getElementById("exchangeRate").value = "";
  document.getElementById("placeOfSupply").value = "Karnataka";

  // Step 3: Clear client information (always)
  document.getElementById("clientCompany").value = "";
  document.getElementById("clientPerson").value = "";
  document.getElementById("clientAddressLine1").value = "";
  document.getElementById("clientState").value = "";
  document.getElementById("clientPinCode").value = "";
  document.getElementById("clientCountrySelect").value = "United States of America";
  document.getElementById("clientEmail").value = "";
  document.getElementById("clientGSTIN").value = "";

  // Step 4: Clear service items (always - keep one empty item)
  document.querySelectorAll(".item").forEach(item => item.remove());
  document.getElementById("addItemBtn").click();

  // Step 5: Payment - restore if user has created invoices before
  if (shouldRestoreUserData && userData.payment) {
    document.getElementById("supportEmail").value = userData.payment.supportEmail || "";
    document.getElementById("dueDays").value = userData.payment.dueDays || "";
    document.getElementById("paymentLink").value = userData.payment.paymentLink || "";
    document.getElementById("bankDetailsToggle").checked = userData.payment.bankDetailsToggle || false;
    document.getElementById("bankDetailsToggle").dispatchEvent(new Event("change"));
    document.getElementById("bankName").value = userData.payment.bankName || "";
    document.getElementById("bankHolder").value = userData.payment.bankHolder || "";
    document.getElementById("bankNumber").value = userData.payment.bankNumber || "";
    document.getElementById("bankIFSC").value = userData.payment.bankIFSC || "";
    document.getElementById("bankBranch").value = userData.payment.bankBranch || "";
    document.getElementById("qrCodeToggle").checked = userData.payment.qrCodeToggle || false;
    document.getElementById("qrCodeToggle").dispatchEvent(new Event("change"));
    if (userData.payment.qrImage) {
      document.getElementById("p-qrImage").src = userData.payment.qrImage;
      document.getElementById("p-qrImage").style.display = "block";
    }
  } else {
    // Clear payment info for first-time users
    document.getElementById("supportEmail").value = "";
    document.getElementById("dueDays").value = "";
    document.getElementById("paymentLink").value = "";
    document.getElementById("bankDetailsToggle").checked = false;
    document.getElementById("bankDetailsToggle").dispatchEvent(new Event("change"));
    document.getElementById("bankName").value = "";
    document.getElementById("bankHolder").value = "";
    document.getElementById("bankNumber").value = "";
    document.getElementById("bankIFSC").value = "";
    document.getElementById("bankBranch").value = "";
    document.getElementById("qrCodeToggle").checked = false;
    document.getElementById("qrCodeToggle").dispatchEvent(new Event("change"));
    document.getElementById("p-qrImage").src = "";
    document.getElementById("p-qrImage").style.display = "none";
    const wiseCode = document.querySelector(".wise-bank-code");
    if (wiseCode) wiseCode.style.display = "none";
  }

  // Step 6: Signature - restore if user has created invoices before
  if (shouldRestoreUserData && userData.signature) {
    document.getElementById("signatureName").value = userData.signature.signatureName || "";
    document.getElementById("signatureTitle").value = userData.signature.signatureTitle || "";
    if (userData.signature.signatureImage) {
      document.getElementById("p-signatureImage").src = userData.signature.signatureImage;
      document.getElementById("p-signatureImage").style.display = "block";
    }
  } else {
    // Clear signature for first-time users
    document.getElementById("signatureName").value = "";
    document.getElementById("signatureTitle").value = "";
    document.getElementById("p-signatureImage").src = "";
    document.getElementById("p-signatureImage").style.display = "none";
  }

  // DO NOT trigger preview updates - preview should stay empty until user types
    console.log('clearInvoiceForm() completed successfully');
  } catch (error) {
    console.error('Error in clearInvoiceForm():', error);
    // Don't re-throw - allow flow to continue
  }
}

// Debounced auto-save function (saves 500ms after user stops typing)
let saveTimeout;
function autoSave() {
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(() => {
    saveToLocalStorage();
  }, 500);
}

// Setup auto-save listeners on all form fields
function setupAutoSave() {
  // Get all input, textarea, and select elements
  const allInputs = document.querySelectorAll('input:not([type="file"]):not([type="button"]), textarea, select');

  allInputs.forEach(input => {
    input.addEventListener('input', autoSave);
    input.addEventListener('change', autoSave);
  });

  // Also save when items are added/deleted
  const addItemBtn = document.getElementById('addItemBtn');
  if (addItemBtn) {
    const originalClick = addItemBtn.onclick;
    addItemBtn.onclick = () => {
      originalClick();
      // Save after item is added and populated
      setTimeout(autoSave, 100);
    };
  }

  // Save when images are uploaded
  document.getElementById('companyLogo').addEventListener('change', () => setTimeout(autoSave, 100));
  document.getElementById('signatureImage').addEventListener('change', () => setTimeout(autoSave, 100));
  document.getElementById('qrImage').addEventListener('change', () => setTimeout(autoSave, 100));
}

/* VIEW NAVIGATION */
// Show dashboard view, hide invoice form
function showDashboard() {
  document.querySelector('.container').style.display = 'none';
  document.querySelector('.dashboard-view').style.display = 'block';
  document.getElementById('backToDashboardBtn').style.display = 'none';
  renderInvoicesList();
}

// Show invoice form, hide dashboard
function showInvoiceForm() {
  document.querySelector('.container').style.display = 'grid';
  document.querySelector('.dashboard-view').style.display = 'none';
  document.getElementById('backToDashboardBtn').style.display = 'block';
  showStep(1); // Start at Step 1
}

// Render list of all invoices in dashboard (spreadsheet-style)
function renderInvoicesList() {
  const invoices = getAllInvoices();
  const listContainer = document.querySelector('.invoices-list');

  if (invoices.length === 0) {
    // Show empty state
    listContainer.innerHTML = `
      <div class="empty-state">
        <h2>No Invoices Yet</h2>
        <p>Click "Create New Invoice" to get started</p>
      </div>
    `;
    return;
  }

  // Generate spreadsheet-style table
  const header = `
    <div class="invoice-table-header">
      <div>Invoice Number</div>
      <div>Date</div>
      <div>Client</div>
      <div>Contact</div>
      <div>Amount</div>
      <div>Actions</div>
    </div>
  `;

  const rows = invoices.map(invoice => {
    const total = calculateInvoiceTotal(invoice);
    const currency = invoice.invoiceCurrency || 'USD';
    const date = invoice.invoiceDate || new Date(invoice.createdAt).toLocaleDateString();

    // All invoices show same action buttons (sample is now editable)
    const actionButtons = `
      <button class="btn-action btn-edit" data-invoice-id="${invoice.id}">Edit</button>
      <button class="btn-action btn-download" data-invoice-id="${invoice.id}">Download</button>
      <button class="btn-action btn-delete" data-invoice-id="${invoice.id}">Delete</button>
    `;

    return `
      <div class="invoice-row" data-invoice-id="${invoice.id}">
        <div class="invoice-cell invoice-cell-number">${invoice.invoiceNumber || 'Draft'}</div>
        <div class="invoice-cell invoice-cell-date">${date}</div>
        <div class="invoice-cell invoice-cell-client">${invoice.clientCompany || 'No client'}</div>
        <div class="invoice-cell invoice-cell-person">${invoice.clientPerson || '-'}</div>
        <div class="invoice-cell invoice-cell-amount">${currency} ${total.toFixed(2)}</div>
        <div class="invoice-cell invoice-cell-actions">
          ${actionButtons}
        </div>
      </div>
    `;
  }).join('');

  listContainer.innerHTML = header + rows;
}

// Setup dashboard event listeners
function setupDashboardListeners() {
  // Create New Invoice button
  const createBtn = document.getElementById('createNewInvoiceBtn');
  console.log('Setting up Create New Invoice button...', createBtn); // Debug
  if (createBtn) {
    // Remove any existing listeners by cloning
    const newBtn = createBtn.cloneNode(true);
    createBtn.parentNode.replaceChild(newBtn, createBtn);

    newBtn.addEventListener('click', (e) => {
      e.preventDefault();
      console.log('Create New Invoice clicked!'); // Debug
      try {
        setCurrentInvoice(null); // New invoice mode
        clearInvoiceForm(); // Prepares form with company/payment info, clears invoice data
        showInvoiceForm(); // Show the form
      } catch (error) {
        console.error('Error in Create New Invoice:', error);
      }
    });
    console.log('Create New Invoice button listener attached successfully');
  } else {
    console.error('Create New Invoice button not found!');
  }

  // Event delegation for dynamically created Edit/Delete/Download buttons
  const listContainer = document.querySelector('.invoices-list');
  if (listContainer) {
    listContainer.addEventListener('click', async (e) => {
      const button = e.target;
      if (!button.matches('.btn-action')) return;

      const invoiceId = button.dataset.invoiceId;
      if (!invoiceId) return;

      if (button.matches('.btn-edit')) {
        setCurrentInvoice(invoiceId);
        restoreFromLocalStorage(); // Load invoice data
        showInvoiceForm();
      }

      if (button.matches('.btn-delete')) {
        if (confirm('Are you sure you want to delete this invoice?')) {
          deleteInvoice(invoiceId);
          renderInvoicesList();
        }
      }

      if (button.matches('.btn-download')) {
        // Load invoice data temporarily, generate PDF, restore current state
        const tempId = currentInvoiceId;
        setCurrentInvoice(invoiceId);
        restoreFromLocalStorage();

        // Wait for data to load, then trigger PDF download
        setTimeout(() => {
          document.getElementById('downloadPdfBtn').click();

          // Restore previous state after download
          setTimeout(() => {
            setCurrentInvoice(tempId);
            if (tempId) {
              restoreFromLocalStorage();
            }
          }, 1000);
        }, 200);
      }
    });
  }
}

/* LOAD SAMPLE DATA */
// Load sample data directly into preview (without filling form fields)
function loadSampleDataToPreview() {
  // Directly set preview elements with sample data (with null checks)
  const pCompanyName = document.getElementById("p-companyName");
  if (pCompanyName) pCompanyName.textContent = "Google India Pvt Ltd";

  const pGstin = document.getElementById("p-gstin");
  if (pGstin) pGstin.textContent = "29AABCG5293F1Z5";

  const pPan = document.getElementById("p-pan");
  if (pPan) pPan.textContent = "AABCG5293F";

  const pCompanyAddress = document.getElementById("p-companyAddress");
  if (pCompanyAddress) pCompanyAddress.textContent = "3, Old Madras Rd, Sadanandanagar, Bennigana Halli,";

  const pCompanyCity = document.getElementById("p-companyCity");
  if (pCompanyCity) pCompanyCity.textContent = "Bangalore";

  const pCompanyState = document.getElementById("p-companyState");
  if (pCompanyState) pCompanyState.textContent = "Karnataka";

  const pCompanyCountry = document.getElementById("p-companyCountry");
  if (pCompanyCountry) pCompanyCountry.textContent = "India";

  const pCompanyPinCode = document.getElementById("p-companyPinCode");
  if (pCompanyPinCode) pCompanyPinCode.textContent = "560001";

  const pCompanyEmail = document.getElementById("p-companyEmail");
  if (pCompanyEmail) pCompanyEmail.textContent = "invoices@google.com";

  const pCompanyPhone = document.getElementById("p-companyPhone");
  if (pCompanyPhone) pCompanyPhone.textContent = "(+91) 80 6744 5000";

  const pInvoiceNumber = document.getElementById("p-invoiceNumber");
  if (pInvoiceNumber) pInvoiceNumber.textContent = "GOOG-2025-DEC-001";

  const pInvoiceDate = document.getElementById("p-invoiceDate");
  if (pInvoiceDate) pInvoiceDate.textContent = "2025-12-13";

  const pLutNumber = document.getElementById("p-lutNumber");
  if (pLutNumber) pLutNumber.textContent = "AD2302220102614";

  const pPlaceOfSupply = document.getElementById("p-placeOfSupply");
  if (pPlaceOfSupply) pPlaceOfSupply.textContent = "Karnataka";

  const pClientCompany = document.getElementById("p-clientCompany");
  if (pClientCompany) pClientCompany.textContent = "Microsoft Corporation";

  const pClientPerson = document.getElementById("p-clientPerson");
  if (pClientPerson) pClientPerson.textContent = "John Smith";

  const pClientAddress = document.getElementById("p-clientAddress");
  if (pClientAddress) pClientAddress.textContent = "One Microsoft Way";

  const pClientState = document.getElementById("p-clientState");
  if (pClientState) pClientState.textContent = "WA";

  const pClientCountry = document.getElementById("p-clientCountry");
  if (pClientCountry) pClientCountry.textContent = "United States of America";

  const pClientPinCode = document.getElementById("p-clientPinCode");
  if (pClientPinCode) pClientPinCode.textContent = "98052";

  const pClientEmail = document.getElementById("p-clientEmail");
  if (pClientEmail) pClientEmail.textContent = "john.smith@microsoft.com";

  const pClientGSTIN = document.getElementById("p-clientGSTIN");
  if (pClientGSTIN) pClientGSTIN.textContent = "Unregistered / Overseas";

  // Sample service item
  const itemsContainer = document.getElementById("items-preview");
  if (itemsContainer) {
    itemsContainer.innerHTML = `
      <div class="item-row">
        <div class="item-content">
          <div class="item-title">Webflow Website Development</div>
          <div class="item-desc">Custom redesign using selected template, including migration of existing site and setup of 7 pages (Home, About, Contact, Team, Case Study CMS, Podcast CMS, Blog CMS). Includes 2 revision rounds.</div>
          <div class="item-sac">SAC: 998314</div>
        </div>
        <div class="item-cost">
          <div class="cost">USD 1,050.00</div>
        </div>
      </div>
      <div class="total-row">
        <div class="total-label"><strong>TOTAL AMOUNT</strong></div>
        <div class="total-amount"><strong>USD 1,050.00</strong></div>
      </div>
    `;
  }

  const pSupportEmail = document.getElementById("p-supportEmail");
  if (pSupportEmail) pSupportEmail.textContent = "invoices@google.com";

  const pDueDays = document.getElementById("p-dueDays");
  if (pDueDays) pDueDays.textContent = "30";

  const pPaymentLink = document.getElementById("p-paymentLink");
  if (pPaymentLink) pPaymentLink.textContent = "https://www.paypal.me/PalashRajput";

  // Show bank details in preview
  const bankDetails = document.querySelector(".bank-details");
  if (bankDetails) {
    bankDetails.style.display = "block";
    bankDetails.innerHTML = `
      <div class="bank"><div class="text-block semi"><strong>HDFC BANK</strong></div></div>
      <div class="bank"><div class="text-block semi"><strong>GOOGLE INDIA PVT LTD</strong></div></div>
      <div class="bank"><div class="text-block semi"><strong>00123456789012</strong></div></div>
      <div class="bank"><div class="text-block semi"><strong>HDFC0000123</strong></div></div>
      <div class="bank"><div class="text-block semi"><strong>KORAMANGALA, BANGALORE</strong></div></div>
    `;
  }

  const pSignatureName = document.getElementById("p-signatureName");
  if (pSignatureName) pSignatureName.textContent = "Sundar Pichai";

  const pSignatureTitle = document.getElementById("p-signatureTitle");
  if (pSignatureTitle) pSignatureTitle.textContent = "Authorized Signatory";
}

// Original loadSampleData (for backwards compatibility if needed)
function loadSampleData() {
  // Step 1: Your Information
  document.getElementById("companyName").value = "Google India Pvt Ltd";
  document.getElementById("gstin").value = "29AABCG5293F1Z5";
  document.getElementById("pan").value = "AABCG5293F";
  document.getElementById("companyAddressLine1").value = "3, Old Madras Rd, Sadanandanagar, Bennigana Halli,";
  document.getElementById("companyCity").value = "Bangalore";
  document.getElementById("companyState").value = "Karnataka";
  document.getElementById("companyCountry").value = "India";
  document.getElementById("companyPinCode").value = "560001";
  document.getElementById("companyEmail").value = "invoices@google.com";
  document.getElementById("companyPhone").value = "(+91) 80 6744 5000";

  // Step 2: Invoice + Currency + GST + LUT
  document.getElementById("invoiceNumber").value = "GOOG-2025-DEC-001";
  document.getElementById("invoiceDate").value = "2025-12-13";
  document.getElementById("lutNumber").value = "AD2302220102614";
  document.getElementById("invoiceCurrency").value = "USD";
  document.getElementById("exchangeRate").value = "90.3702";
  document.getElementById("placeOfSupply").value = "Karnataka";

  // Step 3: Client Information
  document.getElementById("clientCompany").value = "Microsoft Corporation";
  document.getElementById("clientPerson").value = "John Smith";
  document.getElementById("clientAddressLine1").value = "One Microsoft Way";
  document.getElementById("clientState").value = "WA";
  document.getElementById("clientCountrySelect").value = "United States of America";
  document.getElementById("clientPinCode").value = "98052";
  document.getElementById("clientEmail").value = "john.smith@microsoft.com";
  document.getElementById("clientGSTIN").value = "Unregistered / Overseas";

  // Step 4: Add one sample item
  document.getElementById("addItemBtn").click();
  setTimeout(() => {
    const item = document.querySelector(".item");
    if (item) {
      item.querySelector(".title").value = "Webflow Website Development";
      item.querySelector(".desc").value = "Custom redesign using selected template, including migration of existing site and setup of 7 pages (Home, About, Contact, Team, Case Study CMS, Podcast CMS, Blog CMS). Includes 2 revision rounds.";
      item.querySelector(".sac").value = "998314";
      item.querySelector(".amt").value = "1050";
      updateItems();
    }
  }, 100);

  // Step 5: Payment Terms
  document.getElementById("supportEmail").value = "invoices@google.com";
  document.getElementById("dueDays").value = "30";
  document.getElementById("paymentLink").value = "https://www.paypal.me/PalashRajput";
  document.getElementById("bankDetailsToggle").checked = true;
  document.getElementById("bankContainer").classList.remove("hidden");

  document.getElementById("bankName").value = "HDFC BANK";
  document.getElementById("bankHolder").value = "GOOGLE INDIA PVT LTD";
  document.getElementById("bankNumber").value = "00123456789012";
  document.getElementById("bankIFSC").value = "HDFC0000123";
  document.getElementById("bankBranch").value = "KORAMANGALA, BANGALORE";

  // Step 6: Signature
  document.getElementById("signatureName").value = "Sundar Pichai";
  document.getElementById("signatureTitle").value = "Authorized Signatory";

  // Trigger all updates
  document.getElementById("companyName").dispatchEvent(new Event("input"));
  document.getElementById("gstin").dispatchEvent(new Event("input"));
  document.getElementById("pan").dispatchEvent(new Event("input"));
  document.getElementById("companyAddressLine1").dispatchEvent(new Event("input"));
  document.getElementById("companyCity").dispatchEvent(new Event("input"));
  document.getElementById("companyState").dispatchEvent(new Event("input"));
  document.getElementById("companyCountry").dispatchEvent(new Event("input"));
  document.getElementById("companyPinCode").dispatchEvent(new Event("input"));
  document.getElementById("companyEmail").dispatchEvent(new Event("input"));
  document.getElementById("companyPhone").dispatchEvent(new Event("input"));
  document.getElementById("invoiceNumber").dispatchEvent(new Event("input"));
  document.getElementById("invoiceDate").dispatchEvent(new Event("input"));
  document.getElementById("invoiceCurrency").dispatchEvent(new Event("input"));
  document.getElementById("lutNumber").dispatchEvent(new Event("input"));
  document.getElementById("clientCompany").dispatchEvent(new Event("input"));
  document.getElementById("clientPerson").dispatchEvent(new Event("input"));
  document.getElementById("clientAddressLine1").dispatchEvent(new Event("input"));
  document.getElementById("clientState").dispatchEvent(new Event("input"));
  document.getElementById("clientCountrySelect").dispatchEvent(new Event("input"));
  document.getElementById("clientPinCode").dispatchEvent(new Event("input"));
  document.getElementById("clientEmail").dispatchEvent(new Event("input"));
  document.getElementById("clientGSTIN").dispatchEvent(new Event("input"));
  document.getElementById("placeOfSupply").dispatchEvent(new Event("input"));
  document.getElementById("signatureName").dispatchEvent(new Event("input"));
  document.getElementById("signatureTitle").dispatchEvent(new Event("input"));
  document.getElementById("paymentLink").dispatchEvent(new Event("input"));
  document.getElementById("bankDetailsToggle").dispatchEvent(new Event("change"));
  updatePaymentTerms();
  updateBankDetails();
}

// Create default sample invoice (only runs once on first load)
function createSampleInvoice() {
  const sampleInvoice = {
    id: 'sample_invoice_001',
    invoiceNumber: 'SAMPLE-2025-001',
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),

    // Invoice details
    invoiceDate: '2025-12-01',
    lutNumber: 'AD2302220102614',
    invoiceCurrency: 'USD',
    exchangeRate: '90.37',
    placeOfSupply: 'Karnataka',

    // Client
    clientCompany: 'Microsoft Corporation',
    clientPerson: 'John Smith',
    clientAddressLine1: 'One Microsoft Way',
    clientState: 'WA',
    clientPinCode: '98052',
    clientCountrySelect: 'United States of America',
    clientEmail: 'john.smith@microsoft.com',
    clientGSTIN: 'Unregistered / Overseas',

    // Services (total $5000)
    serviceItems: [
      {
        title: 'Cloud Infrastructure Consulting',
        desc: 'Strategic consulting for cloud migration including architecture design, cost optimization, security best practices, and implementation support. Comprehensive service package including 40 hours of expert consultation, documentation, and ongoing support.',
        sac: '998313',
        amt: '5000'
      }
    ],

    // Payment terms
    supportEmail: 'billing@example.com',
    dueDays: '30',
    paymentLink: 'https://www.paypal.me/example',
    bankDetailsToggle: true,
    bankName: 'HDFC BANK',
    bankHolder: 'EXAMPLE COMPANY PVT LTD',
    bankNumber: '00123456789012',
    bankIFSC: 'HDFC0000123',
    bankBranch: 'KORAMANGALA, BANGALORE',
    qrCodeToggle: false,
    qrImage: '',

    // Signature
    signatureName: 'Sample Authorized Signatory',
    signatureTitle: 'Director'
  };

  const data = {
    company: {
      companyName: 'Sample Company Pvt Ltd',
      gstin: '29AABCS1234E1Z5',
      pan: 'AABCS1234E',
      companyAddressLine1: '123 Sample Street, Tech Park',
      companyCity: 'Bangalore',
      companyState: 'Karnataka',
      companyCountry: 'India',
      companyPinCode: '560001',
      companyEmail: 'contact@samplecompany.com',
      companyPhone: '(+91) 80 1234 5678',
      companyLogo: ''
    },
    invoices: [sampleInvoice],
    currentInvoiceId: null
  };

  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

// Initialize app on page load
window.addEventListener("DOMContentLoaded", () => {
  // Migrate old single-invoice data to new structure if needed
  migrateToMultiInvoice();

  // Get current data
  const saved = localStorage.getItem(STORAGE_KEY);
  let data = saved ? JSON.parse(saved) : null;

  // If no data exists, create sample invoice
  if (!data || !data.invoices || data.invoices.length === 0) {
    createSampleInvoice();
    data = JSON.parse(localStorage.getItem(STORAGE_KEY));
  }

  // Always show dashboard (which now has at least the sample invoice)
  showDashboard();

  // Setup auto-save and dashboard listeners
  setupAutoSave();
  setupDashboardListeners();

  // Setup back to dashboard button
  document.getElementById('backToDashboardBtn').addEventListener('click', () => {
    // Save current work before going back
    saveToLocalStorage();
    showDashboard();
  });
});

// Optional: Add a button to clear saved data (for development/testing)
// Uncomment the code below to add a "Clear Saved Data" button to the form
/*
const clearBtn = document.createElement('button');
clearBtn.textContent = 'Clear Saved Data';
clearBtn.style.cssText = 'position: fixed; bottom: 20px; left: 20px; padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; z-index: 1000;';
clearBtn.onclick = () => {
  if (confirm('Are you sure you want to clear all saved data?')) {
    clearLocalStorage();
    location.reload();
  }
};
document.body.appendChild(clearBtn);
*/
</script>

</body>
</html>
